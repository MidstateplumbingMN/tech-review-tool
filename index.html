<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Service Technician Ride-Along Review</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @media print {
            /* HIDE UI ELEMENTS */
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            button { display: none !important; }
            details summary { display: none !important; }
            
            /* PAGE SETUP - MINIMAL MARGINS */
            @page {
                size: letter;
                margin: 0.3in 0.4in;
            }
            
            body { 
                background: white;
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                font-size: 9pt;
                line-height: 1.2;
                color: #000;
            }
            
            /* COMPACT HEADERS */
            h1 {
                font-size: 11pt !important;
                margin: 0 0 2pt 0 !important;
                font-weight: bold;
                border-bottom: 1pt solid #000;
                padding-bottom: 1pt;
            }
            h2 {
                font-size: 10pt !important;
                margin: 3pt 0 2pt 0 !important;
                font-weight: bold;
            }
            h3 {
                font-size: 9pt !important;
                margin: 2pt 0 1pt 0 !important;
                font-weight: bold;
            }
            h4 {
                font-size: 8pt !important;
                margin: 2pt 0 1pt 0 !important;
                font-weight: bold;
            }
            
            /* READABLE TEXT */
            p, div, span {
                font-size: 8pt !important;
                line-height: 1.15 !important;
                margin: 0 0 1pt 0 !important;
            }
            
            /* READABLE LISTS */
            ul, ol {
                margin: 1pt 0 1pt 8pt !important;
                padding: 0 !important;
            }
            li {
                font-size: 7pt !important;
                line-height: 1.1 !important;
                margin: 0 !important;
                break-inside: avoid;
            }
            
            /* CHECKLISTS - COMPACT BUT READABLE */
            .checklist-print {
                font-size: 7pt;
                line-height: 1.1;
                break-inside: avoid;
            }
            
            /* Checklist details in report - COMPACT */
            .bg-white.border {
                padding: 2pt !important;
                margin: 2pt 0 !important;
                border: 0.5pt solid #ddd !important;
                page-break-inside: avoid;
            }
            
            .bg-white.border h4 {
                font-size: 8pt !important;
                margin: 0 0 1pt 0 !important;
                font-weight: bold;
            }
            
            .bg-white.border pre {
                font-size: 7pt !important;
                line-height: 1.15 !important;
                margin: 0 !important;
                padding: 0 !important;
                background: transparent !important;
                font-family: Arial, sans-serif !important;
            }
            
            /* PAGE BREAKS */
            .page-break { page-break-before: auto; }
            .call-section { 
                page-break-inside: avoid;
                margin-bottom: 4pt !important;
                padding: 3pt !important;
                border: 0.5pt solid #ddd !important;
            }
            .single-call-page {
                page-break-after: avoid;
            }
            
            /* Manual page breaks */
            .manual-page-break {
                page-break-before: always !important;
            }
            
            /* Compact call headers */
            .call-section h3 {
                font-size: 9pt !important;
                margin: 0 0 2pt 0 !important;
            }
            
            .call-section .text-xs {
                font-size: 7pt !important;
                line-height: 1.1 !important;
            }
            
            .call-section .text-sm {
                font-size: 8pt !important;
                line-height: 1.15 !important;
            }
            
            /* Compact score grid */
            .call-section .grid {
                gap: 1pt !important;
                margin: 2pt 0 !important;
            }
            
            /* Compact background sections */
            .call-section .bg-gray-50,
            .call-section .bg-blue-50 {
                padding: 2pt !important;
                margin: 2pt 0 !important;
            }
            
            /* CONTAINERS - NO PADDING */
            .print-container {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            .compact {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* SCORES/BADGES - INLINE & TINY */
            .score-badge {
                display: inline;
                padding: 0pt 2pt !important;
                font-size: 6pt !important;
                font-weight: bold;
                background: #f0f0f0 !important;
                border: 0.5pt solid #ccc;
            }
            
            /* TABLE LAYOUT FOR COMPACTNESS */
            .two-column {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4pt;
            }
            
            .three-column {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 3pt;
            }
            
            /* CALL SUMMARY - SUPER COMPACT */
            .call-summary {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 3pt;
                align-items: center;
                font-size: 6pt;
                margin: 1pt 0;
            }
            
            /* HIDE LONG DESCRIPTIONS */
            .step-description { display: none !important; }
            
            /* ENSURE COLOR PRINTING */
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* TINY print-only header to save space */
            .print-only {
                display: block !important;
                padding: 3pt !important;
                margin-bottom: 3pt !important;
                background: white !important;
            }
            
            .print-only h1 {
                font-size: 10pt !important;
                margin: 0 0 2pt 0 !important;
                border-bottom: 0.5pt solid #000 !important;
                padding-bottom: 1pt !important;
            }
            
            .print-only .grid {
                gap: 1pt !important;
                margin: 0 !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
            }
            
            .print-only div {
                font-size: 7pt !important;
                line-height: 1.1 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .print-only strong {
                font-weight: 600 !important;
                font-size: 7pt !important;
            }
        }
        .print-only { display: none; }
        .rating-button {
            transition: all 0.2s;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .rating-button:hover {
            transform: scale(1.05);
        }
        .rating-button:active {
            transform: scale(0.98);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 0 !important;
            }
            .container-max-width {
                padding: 12px !important;
            }
            .card-padding {
                padding: 16px !important;
            }
            .button-text {
                font-size: 14px;
            }
            input, textarea, select {
                font-size: 16px !important;
            }
            .rating-grid {
                gap: 8px;
            }
            .rating-button {
                padding: 12px 8px !important;
                font-size: 16px;
            }
            h1 {
                font-size: 24px !important;
            }
            h2 {
                font-size: 20px !important;
            }
            h3 {
                font-size: 18px !important;
            }
        }
        
        /* Touch improvements for iOS */
        button, input[type="button"], input[type="submit"] {
            -webkit-appearance: none;
            border-radius: 8px;
        }
        
        select, textarea, input {
            -webkit-appearance: none;
            border-radius: 6px;
        }
        
        button {
            touch-action: manipulation;
        }
        
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom Checkbox Styling - VISIBLE CHECKMARKS */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }
        
        input[type="checkbox"]:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        input[type="checkbox"]:hover {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input[type="checkbox"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
                this.setState({ error, errorInfo });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{
                            padding: '40px',
                            maxWidth: '800px',
                            margin: '40px auto',
                            backgroundColor: '#fee',
                            border: '2px solid #c00',
                            borderRadius: '8px'
                        }}>
                            <h1 style={{color: '#c00', marginBottom: '20px'}}>⚠️ Something went wrong</h1>
                            <p style={{marginBottom: '20px'}}>The application encountered an error. Please try refreshing the page.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                style={{
                                    padding: '10px 20px',
                                    backgroundColor: '#c00',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                }}
                            >
                                Refresh Page
                            </button>
                            <details style={{marginTop: '20px', fontSize: '12px'}}>
                                <summary style={{cursor: 'pointer', fontWeight: 'bold'}}>Error Details</summary>
                                <pre style={{
                                    marginTop: '10px',
                                    padding: '10px',
                                    backgroundColor: 'white',
                                    overflow: 'auto'
                                }}>
                                    {this.state.error && this.state.error.toString()}
                                    {this.state.errorInfo && this.state.errorInfo.componentStack}
                                </pre>
                            </details>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Safe localStorage wrapper functions
        const safeLocalStorage = {
            getItem: (key) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error(`Error reading ${key} from localStorage:`, error);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error(`Error saving ${key} to localStorage:`, error);
                    alert('Warning: Could not save data. Your storage may be full.');
                    return false;
                }
            },
            removeItem: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`Error removing ${key} from localStorage:`, error);
                    return false;
                }
            }
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRPG31BJF6BbnN7txtulWRf_y6lseWQ10",
            authDomain: "tech-review-app-758f1.firebaseapp.com",
            projectId: "tech-review-app-758f1",
            storageBucket: "tech-review-app-758f1.firebasestorage.app",
            messagingSenderId: "745422502032",
            appId: "1:745422502032:web:625a900f6b55f7d1a8c015"
        };

        // Initialize Firebase (users will need to replace with their config)
        let db = null;
        let auth = null;
        let firebaseInitialized = false;

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseInitialized = true;
            }
        } catch (error) {
            console.log('Firebase not configured. Cloud backup disabled.');
            firebaseInitialized = false;
        }

        const NexStarReviewTool = () => {
            const [reviewData, setReviewData] = useState({
                technicianName: '',
                trainerName: '',
                reviewDate: new Date().toISOString().split('T')[0],
                reviewStartTime: '', // When review/ride-along started
                reviewFinishTime: '', // When review/ride-along finished
                nextSteps: '',
                calls: [],
                completed: false,
                completedAt: null,
                finalSummary: ''
            });

            const [savedReviews, setSavedReviews] = useState([]);
            const [showLoadModal, setShowLoadModal] = useState(false);
            const [showPrintPreview, setShowPrintPreview] = useState(false);
            const [manualPageBreaks, setManualPageBreaks] = useState([]);
            const [showTechnicianFolders, setShowTechnicianFolders] = useState(false);
            const [selectedTechnician, setSelectedTechnician] = useState(null);
            const [technicianStats, setTechnicianStats] = useState({});
            
            // Trainers list with ability to add custom trainers
            const [trainersList, setTrainersList] = useState(() => {
                const saved = localStorage.getItem('trainersList');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Error loading trainers list:', e);
                    }
                }
                return ['Bob D.', 'Eric S.'];
            });
            
            const [showAddTrainer, setShowAddTrainer] = useState(false);
            const [newTrainerName, setNewTrainerName] = useState('');
            
            // Technicians list with ability to add custom technicians
            const [techniciansList, setTechniciansList] = useState(() => {
                const saved = localStorage.getItem('techniciansList');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Error loading technicians list:', e);
                    }
                }
                return [
                    'Mark Daniels',
                    'Gordy Radant',
                    'Jon Glenn',
                    'Lukas Schlosser',
                    'Gannon Blasier',
                    'Doug McNamara'
                ];
            });
            
            const [showAddTechnician, setShowAddTechnician] = useState(false);
            const [newTechnicianName, setNewTechnicianName] = useState('');
            
            // Department list (fixed)
            const departmentsList = ['Plumbing', 'HVAC', 'Drains'];
            
            // Service list with ability to add custom services
            const [servicesList, setServicesList] = useState(() => {
                const saved = localStorage.getItem('servicesList');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Error loading services list:', e);
                    }
                }
                return ['Call Back', 'Demand', 'Warranty', 'Estimate'];
            });
            
            const [showAddService, setShowAddService] = useState(false);
            const [newServiceName, setNewServiceName] = useState('');
            
            // Network status
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            // Cloud backup state
            const [cloudEnabled, setCloudEnabled] = useState(false);
            const [userEmail, setUserEmail] = useState('');
            const [userPassword, setUserPassword] = useState('');
            const [isSignedIn, setIsSignedIn] = useState(false);
            const [showCloudSetup, setShowCloudSetup] = useState(false);
            const [lastCloudSync, setLastCloudSync] = useState(null);
            const [syncStatus, setSyncStatus] = useState('');

            // Check if user is signed in
            useEffect(() => {
                if (firebaseInitialized && auth) {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            setIsSignedIn(true);
                            setCloudEnabled(true);
                            setUserEmail(user.email);
                            loadFromCloud();
                        } else {
                            setIsSignedIn(false);
                            setCloudEnabled(false);
                        }
                    });
                }
            }, []);
            
            // Offline detection
            useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    console.log('Back online');
                    if (isSignedIn && cloudEnabled) {
                        syncToCloud();
                    }
                };
                
                const handleOffline = () => {
                    setIsOnline(false);
                    console.log('Gone offline');
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [isSignedIn, cloudEnabled]);
            
            // Auto-sync to cloud every 10 minutes
            useEffect(() => {
                if (!isSignedIn || !cloudEnabled || !isOnline) return;
                
                console.log('Starting auto-sync timer (every 10 minutes)');
                
                const interval = setInterval(() => {
                    if (isOnline) {
                        console.log('Auto-sync: Syncing to cloud');
                        syncToCloud();
                    } else {
                        console.log('Auto-sync: Skipped (offline)');
                    }
                }, 600000); // 10 minutes = 600,000ms
                
                return () => {
                    clearInterval(interval);
                    console.log('Auto-sync timer stopped');
                };
            }, [isSignedIn, cloudEnabled, isOnline]);

            // Load saved reviews from localStorage on mount
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('savedReviews');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        let reviews = Array.isArray(parsed) ? parsed : [];
                        
                        // MIGRATION: Add IDs to any reviews that don't have them
                        let migrated = false;
                        reviews = reviews.map(review => {
                            if (!review.id) {
                                migrated = true;
                                return {
                                    ...review,
                                    id: review.savedAt ? new Date(review.savedAt).getTime() : Date.now()
                                };
                            }
                            return review;
                        });
                        
                        if (migrated) {
                            localStorage.setItem('savedReviews', JSON.stringify(reviews));
                            console.log('✓ MIGRATED reviews - added missing IDs');
                        }
                        
                        setSavedReviews(reviews);
                        console.log('Loaded saved reviews:', reviews.length);
                    }
                } catch (error) {
                    console.error('Error loading saved reviews:', error);
                    setSavedReviews([]);
                }

                // Load technician statistics
                try {
                    const stats = localStorage.getItem('technicianStats');
                    if (stats) {
                        const parsed = JSON.parse(stats);
                        setTechnicianStats(parsed || {});
                        console.log('Loaded technician stats');
                    }
                } catch (error) {
                    console.error('Error loading technician stats:', error);
                    setTechnicianStats({});
                }
            }, []);

            // Auto-save current review to localStorage
            useEffect(() => {
                try {
                    if (reviewData.technicianName || (reviewData.calls && reviewData.calls.length > 0)) {
                        localStorage.setItem('currentReview', JSON.stringify(reviewData));
                        console.log('Auto-saved review to localStorage');
                        // Note: Cloud sync happens every 10 minutes automatically
                        // or manually via Save button
                    }
                } catch (error) {
                    console.error('Error auto-saving:', error);
                    if (error.name === 'QuotaExceededError') {
                        alert('Storage quota exceeded. Please export some reviews and clear old data.');
                    }
                }
            }, [reviewData]);
            
            // Auto-sync savedReviews to cloud
            useEffect(() => {
                if (isSignedIn && cloudEnabled && savedReviews.length > 0) {
                    syncToCloud();
                    console.log('Auto-syncing savedReviews to cloud');
                }
            }, [savedReviews]);
            
            // Auto-sync serviceSteps to cloud
            useEffect(() => {
                if (isSignedIn && cloudEnabled) {
                    syncToCloud();
                    console.log('Auto-syncing serviceSteps to cloud');
                }
            }, [serviceSteps]);

            // Update technician statistics
            useEffect(() => {
                if (reviewData.completed && reviewData.technicianName) {
                    updateTechnicianStats();
                }
            }, [reviewData.completed]);

            // Check for duplicates when customer name changes
            useEffect(() => {
                if (currentCall && currentCall.customerName && currentCall.customerName.trim()) {
                    const isDup = reviewData.calls.some(call => {
                        if (editingCallId && call.id === editingCallId) return false;
                        return call.customerName && call.customerName.toLowerCase().trim() === currentCall.customerName.toLowerCase().trim();
                    });
                    setShowDuplicateWarning(isDup);
                } else {
                    setShowDuplicateWarning(false);
                }
            }, [currentCall?.customerName, reviewData.calls, editingCallId]);

            const [currentCall, setCurrentCall] = useState({
                customerName: '',
                customerCity: '',
                department: '',
                service: '',
                callTime: '',
                startTime: '',
                finishTime: '',
                prepare: 0,
                greet: 0,
                explore: 0,
                present: 0,
                execute: 0,
                wrapUp: 0,
                notes: '',
                nextStep: '',
                // Checklist tracking - initialized empty, will be set dynamically
                checklists: null,
                checklistNA: null // Track N/A items separately
            });
            
            const [lastCustomer, setLastCustomer] = useState(null);
            const [showLoadCustomerButton, setShowLoadCustomerButton] = useState(false);
            
            // Format phone number as (555) 555-5555
            
            const loadPreviousCustomer = () => {
                if (lastCustomer) {
                    setCurrentCall(prev => ({
                        ...prev,
                        customerName: lastCustomer.customerName,
                        customerCity: lastCustomer.customerCity
                    }));
                    setShowLoadCustomerButton(false);
                }
            };

            // Initialize checklists when serviceSteps loads
            useEffect(() => {
                if (serviceSteps && serviceSteps.length > 0 && !currentCall.checklists) {
                    const newChecklists = {};
                    const newNA = {};
                    serviceSteps.forEach(step => {
                        newChecklists[step.key] = new Array(step.checklist.length).fill(false);
                        newNA[step.key] = new Array(step.checklist.length).fill(false);
                    });
                    setCurrentCall(prev => ({...prev, checklists: newChecklists, checklistNA: newNA}));
                }
            }, [serviceSteps]);

            const [editingCallId, setEditingCallId] = useState(null);
            const [showChecklist, setShowChecklist] = useState({});
            const [showDuplicateWarning, setShowDuplicateWarning] = useState(false);
            const [showChecklistEditor, setShowChecklistEditor] = useState(false);
            const [editingStep, setEditingStep] = useState(null);

            // Checklist version constant (increment to force update across all users)
            const CHECKLIST_VERSION = '2.0';

            // Service steps with editable checklists - store in state
            const [serviceSteps, setServiceSteps] = useState(() => {
                // Version control for checklists
                const savedVersion = localStorage.getItem('checklistVersion');
                
                // If version mismatch, use new defaults
                if (savedVersion !== CHECKLIST_VERSION) {
                    console.log('Checklist version mismatch. Loading new defaults...');
                    localStorage.removeItem('serviceSteps');
                    localStorage.setItem('checklistVersion', CHECKLIST_VERSION);
                }
                
                // Try to load from localStorage
                const saved = localStorage.getItem('serviceSteps');
                if (saved && savedVersion === CHECKLIST_VERSION) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Error loading service steps:', e);
                    }
                }
                // Default steps - Mid-State Plumbing Custom Checklists
                return [
                    { 
                        key: 'prepare', 
                        label: 'Prepare', 
                        description: 'Reviewed job details, gathered tools, planned approach',
                        checklist: [
                            'Reviewed call notes',
                            'Reviewed previous history',
                            'Gathered all necessary tools and materials',
                            'Reviewed there are the correct checklists attached',
                            'Planned approach to minimize callbacks',
                            'Bring a home club flyer for the homeowner.'
                        ]
                    },
                    { 
                        key: 'greet', 
                        label: 'Greet', 
                        description: 'Professional introduction, built rapport, explained process',
                        checklist: [
                            'Asked the customer if your parking location is acceptable',
                            'Put on shoe covers',
                            'Created great first impression greeting',
                            'Built rapport with customer',
                            'Explained service process clearly',
                            'Take command of the call. Have the customer walk you through the house',
                            'Set expectations. "My goal is 5 star service today, if there\'s anything I can do or if I\'m not meeting that standard, please stop me and let me know."',
                            'Ask the customer if it\'s ok to grab them if you see anything worth their attention',
                            'Ask the customer what their goal is for today. Example "What\'s the optimal outcome for today?" "Is this issue something you want to get started/resolved today?"',
                            'Offer free value added chores. Move/top off softener salt. Swap out old bulbs, test/change out smoke detector/thermostat batteries'
                        ]
                    },
                    { 
                        key: 'explore', 
                        label: 'Explore', 
                        description: 'Asked questions, diagnosed issue, identified all concerns',
                        checklist: [
                            'Asked about customer lifestyle and needs',
                            'Asked open ended questions. "What prompted this call?", "How does this affect you?", "What do you like/dislike about your current system?", and "What would you change if you could?"',
                            'Applied active listening',
                            'Performed thorough system evaluation',
                            'Fill out checklists',
                            'Identified all concerns beyond initial issue',
                            'Look for any other issues. Noisy equipment, leaks in surrounding area, strange smells or sounds.'
                        ]
                    },
                    { 
                        key: 'present', 
                        label: 'Present', 
                        description: 'Clear options, transparent pricing, value communication',
                        checklist: [
                            'Ask if there are any other decision makers that need to be contacted.',
                            'Bring the customer to the equipment, have them touch or get involved.',
                            'Our job is to inform and educate. Clearly explain what and why. What we can do.',
                            'Ensured pricing transparency',
                            'Communicated value matching customer needs. Tie their goals back to the solution.',
                            'Provided multiple options',
                            'Ask if there are any questions before you start.',
                            'Use the IPAD to present solutions clearly',
                            'Give a time frame for the work to be completed',
                            'Offer home club membership 10% discount.'
                        ]
                    },
                    { 
                        key: 'execute', 
                        label: 'Execute', 
                        description: 'Quality workmanship, clean workspace, efficient completion',
                        checklist: [
                            'Performed quality technical work',
                            'Showed gratitude to customer',
                            'Offered Service Partner Plan',
                            'Maintained clean and professional workspace',
                            'Tag and label valves.'
                        ]
                    },
                    { 
                        key: 'wrapUp', 
                        label: 'Wrap Up', 
                        description: 'Explained work, ensured satisfaction, requested reviews',
                        checklist: [
                            'Show customer work completed.',
                            'Show before and after pictures',
                            'Show customer clean workspace.',
                            'Show the customer the labeled tags and value added.',
                            '"I hope I\'ve been able to provide the 5 start service I promised."',
                            'Ask for a review. "We appreciate online review, I enjoy sharing them with the family." "My work is graded on feedback, please take a moment to provide an honest review."',
                            'Express gratitude to the homeowner'
                        ]
                    }
                ];
            });

            // Save serviceSteps to localStorage when changed
            useEffect(() => {
                localStorage.setItem('serviceSteps', JSON.stringify(serviceSteps));
            }, [serviceSteps]);

            // Auto-load last session on startup
            useEffect(() => {
                const timer = setTimeout(() => {
                    // First check for currentReview (in-progress)
                    const saved = localStorage.getItem('currentReview');
                    if (saved) {
                        try {
                            const review = JSON.parse(saved);
                            if (review && (review.technicianName || (review.calls && review.calls.length > 0))) {
                                if (confirm('Load your last in-progress review?')) {
                                    setReviewData(review);
                                    console.log('Loaded currentReview from localStorage');
                                }
                                return; // Exit early if we found currentReview
                            }
                        } catch (error) {
                            console.error('Error loading currentReview:', error);
                        }
                    }
                    
                    // If no currentReview, check for recent savedReviews
                    const savedReviewsStr = localStorage.getItem('savedReviews');
                    if (savedReviewsStr) {
                        try {
                            const reviews = JSON.parse(savedReviewsStr);
                            if (reviews && reviews.length > 0) {
                                // Sort by savedAt, most recent first
                                const sortedReviews = [...reviews].sort((a, b) => 
                                    new Date(b.savedAt) - new Date(a.savedAt)
                                );
                                const mostRecent = sortedReviews[0];
                                const savedDate = new Date(mostRecent.savedAt);
                                const now = new Date();
                                const hoursSince = (now - savedDate) / (1000 * 60 * 60);
                                
                                // If saved within last 24 hours, offer to load it
                                if (hoursSince < 24) {
                                    const message = `Load recent review for ${mostRecent.technicianName} (${mostRecent.reviewDate})?\nSaved ${Math.round(hoursSince)} hours ago.`;
                                    if (confirm(message)) {
                                        loadReview(mostRecent);
                                        console.log('Loaded recent savedReview');
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error checking savedReviews:', error);
                        }
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, []);

            // Checklist management functions
            const updateChecklistItem = (stepKey, itemIndex, newText) => {
                setServiceSteps(prev => prev.map(step => {
                    if (step.key === stepKey) {
                        const newChecklist = [...step.checklist];
                        newChecklist[itemIndex] = newText;
                        return {...step, checklist: newChecklist};
                    }
                    return step;
                }));
            };

            const addChecklistItem = (stepKey) => {
                setServiceSteps(prev => prev.map(step => {
                    if (step.key === stepKey) {
                        return {...step, checklist: [...step.checklist, 'New checklist item']};
                    }
                    return step;
                }));
            };

            const deleteChecklistItem = (stepKey, itemIndex) => {
                setServiceSteps(prev => prev.map(step => {
                    if (step.key === stepKey) {
                        const newChecklist = step.checklist.filter((_, idx) => idx !== itemIndex);
                        return {...step, checklist: newChecklist};
                    }
                    return step;
                }));
            };

            const moveChecklistItem = (stepKey, fromIndex, toIndex) => {
                setServiceSteps(prev => prev.map(step => {
                    if (step.key === stepKey) {
                        const newChecklist = [...step.checklist];
                        const [removed] = newChecklist.splice(fromIndex, 1);
                        newChecklist.splice(toIndex, 0, removed);
                        return {...step, checklist: newChecklist};
                    }
                    return step;
                }));
            };

            const resetToDefaults = () => {
                if (confirm('Reset all checklists to default values? This cannot be undone.')) {
                    localStorage.removeItem('serviceSteps');
                    window.location.reload();
                }
            };

            // Calculate score based on checklist completion
            const calculateScoreFromChecklist = (checklistArray, naArray) => {
                if (!checklistArray || checklistArray.length === 0) return 0;
                
                // Filter out N/A items from scoring
                const applicableItems = checklistArray.map((checked, idx) => {
                    if (naArray && naArray[idx]) return null; // N/A, don't count
                    return checked;
                }).filter(item => item !== null);
                
                if (applicableItems.length === 0) return 0; // All items are N/A
                
                const checked = applicableItems.filter(item => item === true).length;
                const total = applicableItems.length;
                const percentage = (checked / total) * 100;
                
                // Convert percentage to 0-5 scale
                // 100% = 5, 80% = 4, 60% = 3, 40% = 2, 20% = 1, 0% = 0
                if (percentage === 100) return 5;
                if (percentage >= 80) return 4;
                if (percentage >= 60) return 3;
                if (percentage >= 40) return 2;
                if (percentage > 0) return 1;
                return 0;
            };

            // Toggle checklist item
            const toggleChecklistItem = (stepKey, itemIndex) => {
                console.log('Toggle called:', stepKey, itemIndex);
                
                // Ensure checklists exist - initialize if needed
                if (!currentCall.checklists) {
                    console.log('Initializing checklists dynamically');
                    const initChecklists = {};
                    const initNA = {};
                    serviceSteps.forEach(step => {
                        initChecklists[step.key] = new Array(step.checklist.length).fill(false);
                        initNA[step.key] = new Array(step.checklist.length).fill(false);
                    });
                    initChecklists[stepKey][itemIndex] = true;
                    const newScore = calculateScoreFromChecklist(initChecklists[stepKey], initNA[stepKey]);
                    setCurrentCall({
                        ...currentCall, 
                        checklists: initChecklists,
                        checklistNA: initNA,
                        [stepKey]: newScore
                    });
                    return;
                }
                
                // Clone the checklists object
                const newChecklists = JSON.parse(JSON.stringify(currentCall.checklists));
                const newNA = currentCall.checklistNA ? JSON.parse(JSON.stringify(currentCall.checklistNA)) : {};
                
                // Ensure the array exists and has correct length
                const stepInfo = serviceSteps.find(s => s.key === stepKey);
                if (stepInfo && (!newChecklists[stepKey] || newChecklists[stepKey].length !== stepInfo.checklist.length)) {
                    console.log('Resizing checklist array for', stepKey, 'from', newChecklists[stepKey]?.length, 'to', stepInfo.checklist.length);
                    newChecklists[stepKey] = new Array(stepInfo.checklist.length).fill(false);
                    newNA[stepKey] = new Array(stepInfo.checklist.length).fill(false);
                }
                
                // Toggle the specific item
                newChecklists[stepKey][itemIndex] = !newChecklists[stepKey][itemIndex];
                
                // Calculate new score (excluding N/A items)
                const newScore = calculateScoreFromChecklist(newChecklists[stepKey], newNA[stepKey]);
                
                console.log('New score:', newScore, 'Checked:', newChecklists[stepKey].filter(x => x).length, '/', newChecklists[stepKey].length);
                
                // Update state
                setCurrentCall({
                    ...currentCall,
                    checklists: newChecklists,
                    checklistNA: newNA,
                    [stepKey]: newScore
                });
            };

            // Toggle N/A status for checklist item
            const toggleNA = (stepKey, itemIndex) => {
                const newNA = currentCall.checklistNA ? JSON.parse(JSON.stringify(currentCall.checklistNA)) : {};
                const newChecklists = JSON.parse(JSON.stringify(currentCall.checklists));
                
                // Ensure arrays exist
                if (!newNA[stepKey]) {
                    const stepInfo = serviceSteps.find(s => s.key === stepKey);
                    newNA[stepKey] = new Array(stepInfo.checklist.length).fill(false);
                }
                
                // Toggle N/A
                newNA[stepKey][itemIndex] = !newNA[stepKey][itemIndex];
                
                // If marking as N/A, uncheck the item
                if (newNA[stepKey][itemIndex]) {
                    newChecklists[stepKey][itemIndex] = false;
                }
                
                // Recalculate score excluding N/A items
                const newScore = calculateScoreFromChecklist(newChecklists[stepKey], newNA[stepKey]);
                
                setCurrentCall({
                    ...currentCall,
                    checklists: newChecklists,
                    checklistNA: newNA,
                    [stepKey]: newScore
                });
            };

            const getRatingColor = (rating) => {
                if (rating === 0) return 'bg-gray-200 text-gray-400';
                if (rating <= 2) return 'bg-red-500 text-white';
                if (rating === 3) return 'bg-yellow-500 text-white';
                if (rating === 4) return 'bg-blue-500 text-white';
                return 'bg-green-500 text-white';
            };

            const getRatingText = (rating) => {
                if (rating === 0) return 'Not Rated';
                if (rating === 1) return 'Needs Significant Improvement';
                if (rating === 2) return 'Below Standard';
                if (rating === 3) return 'Meets Standard';
                if (rating === 4) return 'Above Standard';
                return 'Exceptional';
            };

            const generateRecommendations = (call) => {
                const recommendations = [];
                
                if (call.prepare <= 2 && call.prepare !== 0 && call.prepare !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Preparation',
                        recommendation: 'Review job details before departure. Watch training videos. Ensure all necessary tools are loaded.'
                    });
                }
                
                if (call.greet <= 2 && call.greet !== 0 && call.greet !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Customer Greeting',
                        recommendation: 'Practice "What\'s Going to Happen" framework. Focus on building immediate trust and rapport.'
                    });
                }
                
                if (call.explore <= 2 && call.explore !== 0 && call.explore !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Exploration/Diagnosis',
                        recommendation: 'Use discovery questions. Listen actively. Complete thorough system evaluation. Identify all concerns.'
                    });
                }
                
                if (call.present <= 2 && call.present !== 0 && call.present !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Solution Presentation',
                        recommendation: 'Use option templates. Clearly explain benefits. Show pricing confidence. Communicate value.'
                    });
                }
                
                if (call.execute <= 2 && call.execute !== 0 && call.execute !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Work Execution',
                        recommendation: 'Follow best practices. Maintain clean workspace. Double-check quality. Practice Service Partner Plan.'
                    });
                }
                
                if (call.wrapUp <= 2 && call.wrapUp !== 0 && call.wrapUp !== 'N/A') {
                    recommendations.push({
                        priority: 'High',
                        area: 'Service Wrap-Up',
                        recommendation: 'Confirm satisfaction. Request Curbside Feedback. Ask for reviews. Discuss future service needs.'
                    });
                }
                
                // Medium priority for scores of 3
                if (call.prepare === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Preparation',
                        recommendation: 'Refine pre-call preparation process for greater efficiency.'
                    });
                }
                
                if (call.greet === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Customer Greeting',
                        recommendation: 'Polish greeting approach to create stronger first impressions.'
                    });
                }
                
                if (call.explore === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Exploration',
                        recommendation: 'Deepen diagnostic questioning to uncover additional opportunities.'
                    });
                }
                
                if (call.present === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Presentation',
                        recommendation: 'Strengthen value communication and pricing confidence.'
                    });
                }
                
                if (call.execute === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Execution',
                        recommendation: 'Enhance efficiency and attention to detail during work.'
                    });
                }
                
                if (call.wrapUp === 3) {
                    recommendations.push({
                        priority: 'Medium',
                        area: 'Wrap-Up',
                        recommendation: 'Strengthen service conclusion and follow-up processes.'
                    });
                }
                
                return recommendations;
            };

            const generateAIReview = (call) => {
                // Safety check
                if (!call || !call.customerName) {
                    return 'Please enter customer name to generate AI review.';
                }

                const scores = {
                    prepare: call.prepare,
                    greet: call.greet,
                    explore: call.explore,
                    present: call.present,
                    execute: call.execute,
                    wrapUp: call.wrapUp
                };

                const timestamp = call.timestamp || call.callTime;
                let dateStr = '';
                let timeStr = '';
                if (timestamp) {
                    try {
                        let date;
                        if (timestamp.includes('T') && timestamp.length === 16) {
                            const [datePart, timePart] = timestamp.split('T');
                            const [year, month, day] = datePart.split('-');
                            const [hour, minute] = timePart.split(':');
                            date = new Date(year, month - 1, day, hour, minute);
                        } else {
                            date = new Date(timestamp);
                        }
                        dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                        timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    } catch (e) {
                        dateStr = 'today';
                    }
                }

                const validScores = Object.values(scores).filter(s => s !== 'N/A' && s !== 0);
                const avgScore = validScores.length > 0 
                    ? (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(1)
                    : 0;

                const notesContext = call.notes || '';
                let review = '';

                const openings = [
                    `I rode along on a service call to ${call.customerName} on ${dateStr} at ${timeStr}.`,
                    `On ${dateStr} at ${timeStr}, I observed the technician during a call with ${call.customerName}.`,
                    `This review covers the ${call.customerName} service call from ${dateStr} at ${timeStr}.`,
                    `Accompanied the technician to ${call.customerName}'s property on ${dateStr} at ${timeStr}.`
                ];
                review += openings[Math.floor(Math.random() * openings.length)] + ' ';

                if (avgScore >= 4.5) {
                    const impressions = ['The technician performed exceptionally well across the board.', 'This was an outstanding service call from start to finish.', 'I was impressed by the technician\'s professionalism and skill throughout.', 'The technician delivered excellent service on this call.'];
                    review += impressions[Math.floor(Math.random() * impressions.length)] + ' ';
                } else if (avgScore >= 4.0) {
                    const impressions = ['The technician did a solid job overall.', 'This was a strong performance with good execution.', 'The technician handled this call professionally.', 'Overall, this was a well-executed service call.'];
                    review += impressions[Math.floor(Math.random() * impressions.length)] + ' ';
                } else if (avgScore >= 3.0) {
                    const impressions = ['The technician met basic standards but has room to improve.', 'This call was acceptable, though several areas need work.', 'The service was adequate but not exceptional.', 'Basic service standards were met on this call.'];
                    review += impressions[Math.floor(Math.random() * impressions.length)] + ' ';
                } else {
                    const impressions = ['This call revealed significant gaps that need immediate attention.', 'Multiple areas need improvement based on this observation.', 'The technician struggled in several key areas during this call.', 'This service call showed clear need for additional training.'];
                    review += impressions[Math.floor(Math.random() * impressions.length)] + ' ';
                }

                review += `Overall score: ${avgScore}/5.0.\n\n`;

                if (notesContext) {
                    review += `${notesContext}\n\n`;
                }

                const excellentAreas = [];
                const goodAreas = [];
                const needsWorkAreas = [];

                if (scores.prepare >= 5) excellentAreas.push('came fully prepared');
                else if (scores.prepare === 4) goodAreas.push('was well-prepared');
                else if (scores.prepare <= 2 && scores.prepare !== 0 && scores.prepare !== 'N/A') needsWorkAreas.push('preparation');

                if (scores.greet >= 5) excellentAreas.push('made a great first impression');
                else if (scores.greet === 4) goodAreas.push('greeted the customer professionally');
                else if (scores.greet <= 2 && scores.greet !== 0 && scores.greet !== 'N/A') needsWorkAreas.push('greeting and rapport building');

                if (scores.explore >= 5) excellentAreas.push('did thorough diagnostics');
                else if (scores.explore === 4) goodAreas.push('asked good questions');
                else if (scores.explore <= 2 && scores.explore !== 0 && scores.explore !== 'N/A') needsWorkAreas.push('diagnostic skills');

                if (scores.present >= 5) excellentAreas.push('presented options clearly');
                else if (scores.present === 4) goodAreas.push('explained solutions well');
                else if (scores.present <= 2 && scores.present !== 0 && scores.present !== 'N/A') needsWorkAreas.push('presenting solutions');

                if (scores.execute >= 5) excellentAreas.push('executed the work flawlessly');
                else if (scores.execute === 4) goodAreas.push('did quality work');
                else if (scores.execute <= 2 && scores.execute !== 0 && scores.execute !== 'N/A') needsWorkAreas.push('technical execution');

                if (scores.wrapUp >= 5) excellentAreas.push('wrapped up professionally');
                else if (scores.wrapUp === 4) goodAreas.push('closed the call well');
                else if (scores.wrapUp <= 2 && scores.wrapUp !== 0 && scores.wrapUp !== 'N/A') needsWorkAreas.push('closing the call');

                if (excellentAreas.length > 0) {
                    const connectors = ['Particularly impressive was how the technician', 'What stood out was that the technician', 'The technician especially excelled by', 'I was pleased to see the technician'];
                    review += `${connectors[Math.floor(Math.random() * connectors.length)]} ${excellentAreas.join(', ')}.`;
                    if (goodAreas.length > 0) {
                        review += ` Also, the technician ${goodAreas.join(', ')}.`;
                    }
                    review += '\n\n';
                } else if (goodAreas.length > 0) {
                    review += `The technician ${goodAreas.join(', ')}, which met expectations.\n\n`;
                }

                if (needsWorkAreas.length > 0) {
                    const phrases = ['Areas needing improvement include', 'The technician should focus on', 'Development is needed in', 'We need to work on'];
                    review += `${phrases[Math.floor(Math.random() * phrases.length)]} ${needsWorkAreas.join(', ')}.`;
                    if (avgScore <= 3.0) {
                        review += ' Schedule follow-up training and coaching.';
                    }
                    review += '\n\n';
                }

                if (avgScore >= 4.5) {
                    const closings = ['Great work overall. Keep it up.', 'Excellent performance. Ready for more responsibility.', 'This is the standard we want to see on every call.', 'Outstanding job. Consider for mentorship opportunities.'];
                    review += closings[Math.floor(Math.random() * closings.length)];
                } else if (avgScore >= 4.0) {
                    const closings = ['Solid performance. Continue developing growth areas.', 'Good job. Focus on consistency across all steps.', 'Well done. Keep working on the development areas.', 'Strong showing. Polish up the areas for improvement.'];
                    review += closings[Math.floor(Math.random() * closings.length)];
                } else if (avgScore >= 3.0) {
                    const closings = ['Schedule weekly check-ins to address development areas.', 'Let\'s set up focused training on growth opportunities.', 'Meets minimum standards. Growth opportunities identified.', 'Follow up in two weeks to track progress.'];
                    review += closings[Math.floor(Math.random() * closings.length)];
                } else {
                    const closings = ['Immediate coaching required. Daily supervision recommended.', 'This requires urgent attention. Set up intensive training.', 'Schedule follow-up ride-along within one week.', 'Significant development needed. Consider additional support.'];
                    review += closings[Math.floor(Math.random() * closings.length)];
                }

                return review;
            };

            const getRecommendation = (step, score) => {
                const recommendations = {
                    prepare: {
                        1: 'Critical: Schedule training on job preparation protocols. Shadow experienced technician for 1 week.',
                        2: 'Important: Review checklist system. Implement pre-call preparation routine.',
                        3: 'Good progress. Fine-tune inventory management and route planning.'
                    },
                    greet: {
                        1: 'Critical: Enroll in customer service training immediately. Practice greeting scripts daily.',
                        2: 'Important: Work on first impression skills. Review company greeting standards.',
                        3: 'Solid foundation. Focus on building deeper rapport and reading customer cues.'
                    },
                    explore: {
                        1: 'Critical: Requires diagnostic training. Pair with senior tech for problem-solving mentorship.',
                        2: 'Important: Improve questioning techniques. Study diagnostic protocols thoroughly.',
                        3: 'Good diagnostic skills. Work on identifying upsell opportunities and hidden issues.'
                    },
                    present: {
                        1: 'Critical: Sales training needed. Learn pricing presentation and value communication strategies.',
                        2: 'Important: Practice option presentation. Work on confidence in pricing discussions.',
                        3: 'Presenting well. Enhance closing techniques and handling objections.'
                    },
                    execute: {
                        1: 'Critical: Technical skills assessment required. Additional hands-on training needed.',
                        2: 'Important: Review quality standards. Focus on efficiency without sacrificing quality.',
                        3: 'Good execution. Optimize time management and maintain consistent quality.'
                    },
                    wrapUp: {
                        1: 'Critical: Learn proper close-out procedures. Practice review requests and follow-up protocols.',
                        2: 'Important: Strengthen wrap-up routine. Improve customer satisfaction confirmation process.',
                        3: 'Wrapping up well. Focus on maximizing review requests and referral opportunities.'
                    }
                };

                return recommendations[step][score] || 'Continue maintaining high standards.';
            };

            // Calculate call duration from start/finish times
            const calculateCallDuration = (startTime, finishTime) => {
                if (!startTime || !finishTime) return null;
                
                try {
                    const start = new Date(startTime);
                    const finish = new Date(finishTime);
                    
                    if (isNaN(start) || isNaN(finish)) return null;
                    
                    const diffMs = finish - start;
                    if (diffMs < 0) return null; // Finish before start
                    
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    // Validate duration (max 24 hours)
                    if (diffMins > 1440) {
                        console.warn('Call duration exceeds 24 hours');
                        return '24h+ (check times)';
                    }
                    
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    
                    if (hours > 0) {
                        return `${hours}h ${mins}m`;
                    } else {
                        return `${mins}m`;
                    }
                } catch (e) {
                    return null;
                }
            };
            
            // Calculate average call duration from an array of calls
            const calculateAverageCallDuration = (calls) => {
                const durations = calls.map(call => {
                    if (!call.startTime || !call.finishTime) return null;
                    try {
                        const start = new Date(call.startTime);
                        const finish = new Date(call.finishTime);
                        if (isNaN(start) || isNaN(finish)) return null;
                        const diffMs = finish - start;
                        if (diffMs < 0 || diffMs > 86400000) return null; // Negative or > 24h
                        return diffMs / 60000; // Return minutes
                    } catch (e) {
                        return null;
                    }
                }).filter(d => d !== null);
                
                if (durations.length === 0) return null;
                
                const avgMins = Math.round(durations.reduce((a, b) => a + b, 0) / durations.length);
                const hours = Math.floor(avgMins / 60);
                const mins = avgMins % 60;
                
                if (hours > 0) {
                    return `${hours}h ${mins}m`;
                } else {
                    return `${mins}m`;
                }
            };

            const generateCallReview = (call) => {
                const scores = [call.prepare, call.greet, call.explore, call.present, call.execute, call.wrapUp]
                    .filter(score => score !== 'N/A' && score !== 0);
                
                if (scores.length === 0) {
                    return {
                        summary: 'No ratings provided for this call.',
                        avgScore: 'N/A',
                        lowestScore: 'N/A',
                        highestScore: 'N/A'
                    };
                }

                const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                const lowestScore = Math.min(...scores);
                const highestScore = Math.max(...scores);

                // Create unique summary based on specific score patterns
                let summary = '';
                // Use start time for the review timestamp
                const timestamp = call.startTime || call.timestamp || call.callTime;
                
                // Format timestamp properly - parse datetime-local format
                let timeStr = '';
                if (timestamp) {
                    try {
                        // If it's in datetime-local format (YYYY-MM-DDTHH:mm), parse it directly
                        let date;
                        if (timestamp.includes('T') && timestamp.length === 16) {
                            // datetime-local format: "2024-12-23T14:30"
                            const [datePart, timePart] = timestamp.split('T');
                            const [year, month, day] = datePart.split('-');
                            const [hour, minute] = timePart.split(':');
                            date = new Date(year, month - 1, day, hour, minute);
                        } else {
                            // ISO format or other
                            date = new Date(timestamp);
                        }
                        
                        // Format in Central Time with fallback
                        let dateStr, timeOnlyStr;
                        try {
                            dateStr = date.toLocaleDateString('en-US', { 
                                month: 'numeric', 
                                day: 'numeric', 
                                year: 'numeric',
                                timeZone: 'America/Chicago'
                            });
                            timeOnlyStr = date.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true,
                                timeZone: 'America/Chicago'
                            });
                        } catch (tzError) {
                            // Fallback if timezone not supported
                            console.warn('Central Time not supported, using local time');
                            dateStr = date.toLocaleDateString('en-US', { 
                                month: 'numeric', 
                                day: 'numeric', 
                                year: 'numeric'
                            });
                            timeOnlyStr = date.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true
                            });
                        }
                        
                        timeStr = ` on ${dateStr} at ${timeOnlyStr}`;
                        
                        // Add call duration if available
                        const duration = calculateCallDuration(call.startTime, call.finishTime);
                        if (duration) {
                            timeStr += ` (${duration} call duration)`;
                        }
                    } catch (e) {
                        console.error('Date parsing error:', e);
                        timeStr = '';
                    }
                }

                // Performance opening based on average
                if (avgScore >= 4.5) {
                    const openers = [
                        `Exceptional execution during the ${call.customerName} service call${timeStr}.`,
                        `${call.customerName} received outstanding service${timeStr} across all evaluated areas.`,
                        `This call to ${call.customerName}${timeStr} exemplifies service excellence.`,
                        `Masterful performance demonstrated with ${call.customerName}${timeStr}.`
                    ];
                    summary = openers[Math.floor(Math.random() * openers.length)] + ' ';
                } else if (avgScore >= 4.0) {
                    const openers = [
                        `Strong professional service delivered to ${call.customerName}${timeStr}.`,
                        `Solid performance on the ${call.customerName} call${timeStr} with clear competency shown.`,
                        `Quality service provided to ${call.customerName}${timeStr} meeting high standards.`,
                        `The ${call.customerName} service call${timeStr} demonstrated capable execution.`
                    ];
                    summary = openers[Math.floor(Math.random() * openers.length)] + ' ';
                } else if (avgScore >= 3.0) {
                    const openers = [
                        `Service call with ${call.customerName}${timeStr} met basic requirements with room for growth.`,
                        `Acceptable performance during the ${call.customerName} visit${timeStr}, though improvements are needed.`,
                        `The ${call.customerName} call${timeStr} achieved baseline standards but showed development opportunities.`,
                        `Standard service delivery to ${call.customerName}${timeStr} with notable areas requiring attention.`
                    ];
                    summary = openers[Math.floor(Math.random() * openers.length)] + ' ';
                } else {
                    const openers = [
                        `Significant concerns arose during the ${call.customerName} service call${timeStr}.`,
                        `The visit to ${call.customerName}${timeStr} revealed multiple performance deficiencies.`,
                        `Critical development needs identified from the ${call.customerName} call${timeStr}.`,
                        `Service delivery to ${call.customerName}${timeStr} fell short of acceptable standards.`
                    ];
                    summary = openers[Math.floor(Math.random() * openers.length)] + ' ';
                }

                // Add specific insights based on individual scores
                const growthAreas = serviceSteps.filter(step => call[step.key] !== 'N/A' && call[step.key] <= 2).map(s => s.label);
                const strongAreas = serviceSteps.filter(step => call[step.key] !== 'N/A' && call[step.key] >= 4).map(s => s.label);
                const moderateAreas = serviceSteps.filter(step => call[step.key] === 3).map(s => s.label);

                // Build unique middle content
                if (strongAreas.length > 0 && growthAreas.length > 0) {
                    summary += `Notable strengths in ${strongAreas.join(' and ')} contrasted with growth opportunities in ${growthAreas.join(' and ')}. `;
                } else if (strongAreas.length > 0) {
                    summary += `Particularly strong performance in ${strongAreas.join(', ')}, showcasing clear capability in these areas. `;
                } else if (growthAreas.length > 0) {
                    summary += `Primary development opportunities centered on ${growthAreas.join(', ')}, requiring focused coaching attention. `;
                }

                if (moderateAreas.length > 0) {
                    summary += `Solid execution in ${moderateAreas.join(' and ')} suggests potential for enhancement with focused practice. `;
                }

                // Add unique closing based on score variance
                const variance = scores.length > 1 
                    ? Math.sqrt(scores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / scores.length)
                    : 0;

                if (variance < 0.5) {
                    summary += 'Performance was notably consistent across all service steps.';
                } else if (variance < 1.0) {
                    summary += 'Some variation in execution quality observed between different service phases.';
                } else {
                    summary += 'Significant inconsistency noted between steps, indicating uneven skill development.';
                }

                return {
                    summary,
                    avgScore,
                    lowestScore,
                    highestScore,
                    checklistDetails: generateChecklistSummary(call)
                };
            };

            const generateChecklistSummary = (call) => {
                if (!call.checklists) return '';
                
                let details = '';
                serviceSteps.forEach(step => {
                    const checklist = call.checklists[step.key];
                    const naArray = call.checklistNA && call.checklistNA[step.key];
                    if (!checklist || checklist.length === 0) return;
                    
                    const checkedItems = [];
                    const uncheckedItems = [];
                    const naItems = [];
                    
                    step.checklist.forEach((item, idx) => {
                        // Check if item is marked as N/A
                        if (naArray && naArray[idx]) {
                            naItems.push(item);
                        } else if (checklist[idx]) {
                            checkedItems.push(item);
                        } else {
                            uncheckedItems.push(item);
                        }
                    });
                    
                    // Calculate percentage excluding N/A items
                    const applicableTotal = step.checklist.length - naItems.length;
                    const checked = checkedItems.length;
                    const percentage = applicableTotal > 0 ? Math.round((checked / applicableTotal) * 100) : 0;
                    
                    details += `\n${step.label} (${checked}/${applicableTotal} - ${percentage}%):\n`;
                    
                    checkedItems.forEach(item => {
                        details += `  ✓ ${item}\n`;
                    });
                    
                    uncheckedItems.forEach(item => {
                        details += `  ☐ ${item}\n`;
                    });
                    
                    if (naItems.length > 0) {
                        naItems.forEach(item => {
                            details += `  N/A ${item}\n`;
                        });
                    }
                });
                
                return details;
            };

            const generateOverallSummary = () => {
                if (reviewData.calls.length === 0) return '';

                const allScores = reviewData.calls.flatMap(call => 
                    [call.prepare, call.greet, call.explore, call.present, call.execute, call.wrapUp]
                ).filter(score => score !== 'N/A' && score !== 0);
                
                if (allScores.length === 0) return 'No ratings provided.';

                const overallAvg = (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1);

                const stepAverages = serviceSteps.map(step => {
                    const stepScores = reviewData.calls
                        .map(call => call[step.key])
                        .filter(score => score !== 'N/A' && score !== 0);
                    
                    if (stepScores.length === 0) return { step: step.label, avg: 'N/A' };
                    
                    return {
                        step: step.label,
                        avg: (stepScores.reduce((a, b) => a + b, 0) / stepScores.length).toFixed(1)
                    };
                });

                const validAverages = stepAverages.filter(s => s.avg !== 'N/A');
                const growthStep = validAverages.reduce((min, curr) => 
                    parseFloat(curr.avg) < parseFloat(min.avg) ? curr : min
                );
                const strongestStep = validAverages.reduce((max, curr) => 
                    parseFloat(curr.avg) > parseFloat(max.avg) ? curr : max
                );

                let summary = `Ride-Along Summary for ${reviewData.technicianName} - ${reviewData.reviewDate}\n\n`;
                summary += `Calls Observed: ${reviewData.calls.length}\n`;
                summary += `Overall Average Score: ${overallAvg}/5.0 (${getRatingText(Math.round(overallAvg))})\n\n`;
                
                summary += `Performance by Service Step:\n`;
                stepAverages.forEach(step => {
                    summary += `• ${step.step}: ${step.avg === 'N/A' ? 'N/A' : step.avg + '/5.0'}\n`;
                });

                if (validAverages.length > 0) {
                    summary += `\nKey Observations:\n`;
                    summary += `• Strongest Area: ${strongestStep.step} (${strongestStep.avg}/5.0)\n`;
                    summary += `• Growth Opportunity: ${growthStep.step} (${growthStep.avg}/5.0)\n\n`;
                }

                if (overallAvg >= 4.5) {
                    summary += `${reviewData.technicianName} demonstrates exceptional mastery of the Service System. Consistently delivers outstanding customer experiences across all touchpoints. Ready for advanced responsibilities and mentorship roles.\n`;
                } else if (overallAvg >= 4.0) {
                    summary += `${reviewData.technicianName} shows strong competency in the Service System. With continued focus on development areas, will achieve exceptional performance levels.\n`;
                } else if (overallAvg >= 3.0) {
                    summary += `${reviewData.technicianName} meets basic service standards with room for growth. Recommend targeted training in identified development areas to reach excellence.\n`;
                } else {
                    summary += `${reviewData.technicianName} requires immediate coaching support and structured development plan. Schedule weekly sessions and provide additional training resources.\n`;
                }

                return summary;
            };

            const addCall = () => {
                try {
                    if (!currentCall.customerName || currentCall.prepare === 0) {
                        alert('Please fill in customer name and rate all service steps.');
                        return;
                    }

                    // Check for duplicates (excluding the call being edited)
                    const isDuplicate = reviewData.calls.some(call => {
                        if (editingCallId && call.id === editingCallId) return false; // Skip the call being edited
                        
                        const nameMatch = call.customerName && currentCall.customerName &&
                            call.customerName.toLowerCase().trim() === currentCall.customerName.toLowerCase().trim();
                        const cityMatch = call.customerCity && currentCall.customerCity && 
                            call.customerCity.toLowerCase().trim() === currentCall.customerCity.toLowerCase().trim();
                        
                        // Consider it duplicate if name matches AND city matches
                        return nameMatch && cityMatch;
                    });

                    if (isDuplicate && !editingCallId) {
                        const proceed = confirm(
                            `⚠️ DUPLICATE DETECTED\n\n` +
                            `A call for "${currentCall.customerName}" with matching information already exists.\n\n` +
                            `Do you want to add it anyway?`
                        );
                        if (!proceed) return;
                    }

                    // Store startTime as timestamp for display, or current time if blank
                    const callWithTimestamp = {
                        ...currentCall,
                        timestamp: currentCall.startTime || new Date().toISOString().slice(0, 16),
                        callTime: undefined // Remove old callTime field
                    };

                    if (editingCallId) {
                        // Update existing call
                        setReviewData(prev => ({
                            ...prev,
                            calls: prev.calls.map(call => 
                                call.id === editingCallId ? { ...callWithTimestamp, id: editingCallId } : call
                            )
                        }));
                        setEditingCallId(null);
                        alert('✓ Call updated successfully!');
                    } else {
                        // Add new call
                        setReviewData(prev => ({
                            ...prev,
                            calls: [...prev.calls, { ...callWithTimestamp, id: Date.now() }]
                        }));
                    }

                    // Save customer info for "Load Previous Customer" button
                    setLastCustomer({
                        customerName: currentCall.customerName,
                        customerCity: currentCall.customerCity
                    });
                    
                    // Show load button for next call
                    setShowLoadCustomerButton(true);
                    
                    // Reset currentCall with fresh checklists (CLEAR everything)
                    const freshChecklists = {};
                    serviceSteps.forEach(step => {
                        freshChecklists[step.key] = new Array(step.checklist.length).fill(false);
                    });
                    
                    setCurrentCall({
                        customerName: '',
                        customerCity: '',
                        department: '',
                        service: '',
                        callTime: '',
                        prepare: 0,
                        greet: 0,
                        explore: 0,
                        present: 0,
                        execute: 0,
                        wrapUp: 0,
                        notes: '',
                        nextStep: '',
                        checklists: freshChecklists
                    });
                    setShowDuplicateWarning(false);
                } catch (error) {
                    console.error('Error in addCall:', error);
                    alert('An error occurred. Please try again.');
                }
            };

            const editCall = (call) => {
                console.log('Editing call:', call.id, 'Checklists:', call.checklists);
                
                // Format timestamp for datetime-local input (YYYY-MM-DDTHH:MM)
                let formattedTime = '';
                try {
                    if (call.timestamp || call.callTime) {
                        const date = new Date(call.timestamp || call.callTime);
                        if (!isNaN(date.getTime())) {
                            formattedTime = date.toISOString().slice(0, 16);
                        }
                    }
                } catch (error) {
                    console.error('Error formatting date:', error);
                    formattedTime = '';
                }

                // Ensure checklists match current serviceSteps structure
                let loadedChecklists;
                if (call.checklists) {
                    loadedChecklists = {};
                    serviceSteps.forEach(step => {
                        if (call.checklists[step.key] && call.checklists[step.key].length === step.checklist.length) {
                            // Array size matches, use it
                            loadedChecklists[step.key] = [...call.checklists[step.key]];
                        } else if (call.checklists[step.key]) {
                            // Array exists but wrong size, resize it
                            const oldArray = call.checklists[step.key];
                            const newArray = new Array(step.checklist.length).fill(false);
                            // Copy over existing values where possible
                            for (let i = 0; i < Math.min(oldArray.length, newArray.length); i++) {
                                newArray[i] = oldArray[i];
                            }
                            loadedChecklists[step.key] = newArray;
                            console.log(`Resized ${step.key} from ${oldArray.length} to ${newArray.length}`);
                        } else {
                            // No array for this step, create empty one
                            loadedChecklists[step.key] = new Array(step.checklist.length).fill(false);
                            console.log(`Created empty checklist for ${step.key}`);
                        }
                    });
                } else {
                    // No checklists at all, create empty structure
                    loadedChecklists = {};
                    serviceSteps.forEach(step => {
                        loadedChecklists[step.key] = new Array(step.checklist.length).fill(false);
                    });
                    console.log('No checklists found, created empty structure');
                }

                setCurrentCall({
                    customerName: call.customerName || '',
                    customerCity: call.customerCity || call.customerAddress || '', // Support old data
                    department: call.department || '',
                    service: call.service || '',
                    serviceType: call.serviceType || '', // Keep for backward compatibility
                    callTime: formattedTime,
                    prepare: call.prepare || 0,
                    greet: call.greet || 0,
                    explore: call.explore || 0,
                    present: call.present || 0,
                    execute: call.execute || 0,
                    wrapUp: call.wrapUp || 0,
                    notes: call.notes || '',
                    nextStep: call.nextStep || '',
                    checklists: loadedChecklists
                });
                
                console.log('Loaded checklists into form:', loadedChecklists);
                setEditingCallId(call.id);
                // Scroll to form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingCallId(null);
                setCurrentCall({
                    customerName: '',
                    customerCity: '',
                    department: '',
                    service: '',
                    callTime: '',
                    prepare: 0,
                    greet: 0,
                    explore: 0,
                    present: 0,
                    execute: 0,
                    wrapUp: 0,
                    notes: '',
                    nextStep: '',
                    checklists: (() => {
                        const newChecklists = {};
                        serviceSteps.forEach(step => {
                            newChecklists[step.key] = new Array(step.checklist.length).fill(false);
                        });
                        return newChecklists;
                    })()
                });
            };

            const removeCall = (id) => {
                setReviewData(prev => ({
                    ...prev,
                    calls: prev.calls.filter(call => call.id !== id)
                }));
            };

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let yPos = 20;

                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('NexStar Service Technician Ride-Along Review', 105, yPos, { align: 'center' });
                yPos += 15;

                // Tech Info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Technician: ${reviewData.technicianName}`, 20, yPos);
                yPos += 7;
                doc.text(`Date: ${reviewData.reviewDate}`, 20, yPos);
                yPos += 10;

                // Overall Summary
                doc.setFont(undefined, 'bold');
                doc.text('Overall Summary:', 20, yPos);
                yPos += 7;
                doc.setFont(undefined, 'normal');
                
                const summaryText = reviewData.completed && reviewData.finalSummary 
                    ? reviewData.finalSummary 
                    : generateOverallSummary();
                
                const summaryLines = doc.splitTextToSize(summaryText, 170);
                summaryLines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 5;
                });

                // Each Call
                reviewData.calls.forEach((call, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }

                    yPos += 10;
                    doc.setFont(undefined, 'bold');
                    doc.text(`Call ${index + 1}: ${call.customerName}`, 20, yPos);
                    yPos += 7;
                    
                    doc.setFont(undefined, 'normal');
                    const callReview = generateCallReview(call);
                    doc.text(`Average Score: ${callReview.avgScore === 'N/A' ? 'N/A' : callReview.avgScore + '/5.0'}`, 20, yPos);
                    yPos += 7;

                    serviceSteps.forEach(step => {
                        const score = call[step.key];
                        doc.text(`${step.label}: ${score === 'N/A' ? 'N/A' : score + '/5'}`, 20, yPos);
                        yPos += 6;
                    });

                    if (call.notes) {
                        yPos += 3;
                        doc.text('Notes:', 20, yPos);
                        yPos += 5;
                        const notesLines = doc.splitTextToSize(call.notes, 170);
                        notesLines.forEach(line => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, 20, yPos);
                            yPos += 5;
                        });
                    }

                    if (call.nextStep) {
                        yPos += 3;
                        doc.setFont(undefined, 'bold');
                        doc.text('Next Step:', 20, yPos);
                        yPos += 5;
                        doc.setFont(undefined, 'normal');
                        const nextStepLines = doc.splitTextToSize(call.nextStep, 170);
                        nextStepLines.forEach(line => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, 20, yPos);
                            yPos += 5;
                        });
                    }

                    // Recommendations for this call
                    const recommendations = generateRecommendations(call);
                    if (recommendations.length > 0) {
                        yPos += 5;
                        doc.setFont(undefined, 'bold');
                        doc.text('Recommendations:', 20, yPos);
                        yPos += 6;
                        doc.setFont(undefined, 'normal');
                        recommendations.forEach(rec => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            const recLines = doc.splitTextToSize(`[${rec.priority}] ${rec.area}: ${rec.recommendation}`, 170);
                            recLines.forEach(line => {
                                doc.text(line, 20, yPos);
                                yPos += 5;
                            });
                        });
                    }
                });

                // Next Steps
                if (reviewData.nextSteps) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    yPos += 10;
                    doc.setFont(undefined, 'bold');
                    doc.text('Next Steps:', 20, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                    const nextStepsLines = doc.splitTextToSize(reviewData.nextSteps, 170);
                    nextStepsLines.forEach(line => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }

                doc.save(`RideAlong_${reviewData.technicianName}_${reviewData.reviewDate}.pdf`);
            };

            const printToPDF = () => {
                // Trigger browser print dialog
                window.print();
            };

            const generateFinalSummary = () => {
                if (reviewData.calls.length === 0) return '';

                const allScores = reviewData.calls.flatMap(call => 
                    [call.prepare, call.greet, call.explore, call.present, call.execute, call.wrapUp]
                ).filter(score => score !== 'N/A' && score !== 0);
                
                if (allScores.length === 0) return 'Insufficient data for final summary.';

                const overallAvg = (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1);

                // Calculate performance metrics
                const stepAverages = serviceSteps.map(step => {
                    const stepScores = reviewData.calls
                        .map(call => call[step.key])
                        .filter(score => score !== 'N/A' && score !== 0);
                    
                    if (stepScores.length === 0) return { step: step.label, avg: 0, count: 0 };
                    
                    return {
                        step: step.label,
                        key: step.key,
                        avg: parseFloat((stepScores.reduce((a, b) => a + b, 0) / stepScores.length).toFixed(1)),
                        count: stepScores.length
                    };
                }).filter(s => s.count > 0);

                const excellentAreas = stepAverages.filter(s => s.avg >= 4.5);
                const strongAreas = stepAverages.filter(s => s.avg >= 4 && s.avg < 4.5);
                const improvementAreas = stepAverages.filter(s => s.avg < 3);
                const criticalAreas = stepAverages.filter(s => s.avg < 2);

                // Calculate consistency
                const callAverages = reviewData.calls.map(call => {
                    const scores = [call.prepare, call.greet, call.explore, call.present, call.execute, call.wrapUp]
                        .filter(s => s !== 'N/A' && s !== 0);
                    return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
                }).filter(avg => avg > 0);

                const avgVariance = callAverages.length > 1 
                    ? Math.sqrt(callAverages.reduce((sum, avg) => sum + Math.pow(avg - overallAvg, 2), 0) / callAverages.length).toFixed(2)
                    : 0;

                const consistency = avgVariance < 0.5 ? 'highly consistent' : avgVariance < 1.0 ? 'generally consistent' : 'inconsistent';

                // Generate unique insights
                let summary = `═══════════════════════════════════════════════════════\n`;
                summary += `FINAL RIDE-ALONG EVALUATION\n`;
                summary += `Technician: ${reviewData.technicianName}\n`;
                summary += `Review Date: ${reviewData.reviewDate}\n`;
                summary += `Completed: ${new Date().toLocaleString()}\n`;
                summary += `═══════════════════════════════════════════════════════\n\n`;

                // Executive Summary
                summary += `EXECUTIVE SUMMARY\n`;
                summary += `─────────────────────────────────────────────────────\n`;
                summary += `Calls Observed: ${reviewData.calls.length}\n`;
                summary += `Overall Performance Score: ${overallAvg}/5.0 (${getRatingText(Math.round(overallAvg))})\n`;
                summary += `Performance Consistency: ${consistency.toUpperCase()} (variance: ${avgVariance})\n\n`;

                // Performance Classification
                if (overallAvg >= 4.5) {
                    summary += `PERFORMANCE CLASSIFICATION: EXCEPTIONAL\n`;
                    summary += `${reviewData.technicianName} demonstrates mastery-level competency across all service touchpoints. This technician consistently exceeds customer expectations and represents the gold standard for service delivery. Strong candidate for:\n`;
                    summary += `• Lead technician or mentor role\n`;
                    summary += `• Training program development\n`;
                    summary += `• Complex or high-value service calls\n`;
                    summary += `• Customer recovery situations\n\n`;
                } else if (overallAvg >= 4.0) {
                    summary += `PERFORMANCE CLASSIFICATION: STRONG PERFORMER\n`;
                    summary += `${reviewData.technicianName} consistently delivers quality service with professional execution. With targeted development in identified areas, this technician is on track for excellence. Recommended actions:\n`;
                    summary += `• Continue current trajectory with minor refinements\n`;
                    summary += `• Consider for intermediate mentorship opportunities\n`;
                    summary += `• Eligible for advanced technical training\n\n`;
                } else if (overallAvg >= 3.0) {
                    summary += `PERFORMANCE CLASSIFICATION: DEVELOPING\n`;
                    summary += `${reviewData.technicianName} meets baseline service standards but requires structured development to reach proficiency. This is a critical development period. Immediate actions required:\n`;
                    summary += `• Weekly one-on-one coaching sessions\n`;
                    summary += `• Targeted training in growth opportunities\n`;
                    summary += `• 30-day performance improvement plan\n`;
                    summary += `• Follow-up ride-along in 4-6 weeks\n\n`;
                } else {
                    summary += `PERFORMANCE CLASSIFICATION: REQUIRES IMMEDIATE INTERVENTION\n`;
                    summary += `${reviewData.technicianName} is performing below acceptable standards across multiple competencies. Immediate corrective action is required to prevent customer dissatisfaction and business impact. Critical actions:\n`;
                    summary += `• Immediate suspension from solo calls\n`;
                    summary += `• Intensive retraining program\n`;
                    summary += `• Daily supervision and coaching\n`;
                    summary += `• 2-week performance evaluation\n`;
                    summary += `• Consider role reassignment if no improvement\n\n`;
                }

                // Detailed Performance Breakdown
                summary += `DETAILED PERFORMANCE BREAKDOWN\n`;
                summary += `─────────────────────────────────────────────────────\n`;
                stepAverages.forEach(step => {
                    const bar = '█'.repeat(Math.round(step.avg)) + '░'.repeat(5 - Math.round(step.avg));
                    const stepDef = serviceSteps.find(s => s.key === step.key);
                    summary += `${step.step}: ${step.avg}/5.0 ${bar} (${step.count} observations)\n`;
                    if (stepDef && stepDef.checklist) {
                        summary += `  Key Elements:\n`;
                        stepDef.checklist.forEach((item, idx) => {
                            summary += `    ${idx + 1}. ${item}\n`;
                        });
                    }
                    summary += `\n`;
                });
                summary += `\n`;

                // Strength Analysis
                if (excellentAreas.length > 0) {
                    summary += `EXCEPTIONAL STRENGTHS\n`;
                    summary += `─────────────────────────────────────────────────────\n`;
                    excellentAreas.forEach(area => {
                        summary += `✓ ${area.step} (${area.avg}/5.0): `;
                        if (area.key === 'prepare') summary += `Outstanding job preparation and planning. Consistently arrives with complete information and proper equipment.\n`;
                        if (area.key === 'greet') summary += `Exceptional customer rapport and professionalism. Creates immediate trust and confidence.\n`;
                        if (area.key === 'explore') summary += `Superior diagnostic skills. Identifies all issues and asks probing questions effectively.\n`;
                        if (area.key === 'present') summary += `Excellence in presenting solutions. Clear communication of options and pricing with strong value articulation.\n`;
                        if (area.key === 'execute') summary += `Masterful technical execution. Efficient, clean, and quality-focused workmanship.\n`;
                        if (area.key === 'wrapUp') summary += `Outstanding service conclusion. Ensures complete satisfaction and secures future business.\n`;
                    });
                    summary += `\n`;
                }

                if (strongAreas.length > 0) {
                    summary += `SOLID COMPETENCIES\n`;
                    summary += `─────────────────────────────────────────────────────\n`;
                    strongAreas.forEach(area => {
                        summary += `• ${area.step} (${area.avg}/5.0): Performing well, minor refinements recommended\n`;
                    });
                    summary += `\n`;
                }

                // Development Areas
                if (improvementAreas.length > 0) {
                    summary += `PRIMARY DEVELOPMENT AREAS\n`;
                    summary += `─────────────────────────────────────────────────────\n`;
                    improvementAreas.forEach(area => {
                        summary += `⚠ ${area.step} (${area.avg}/5.0): `;
                        if (area.key === 'prepare') summary += `Requires better pre-call preparation. Missing information or tools impacting efficiency.\n`;
                        if (area.key === 'greet') summary += `Customer engagement needs improvement. Work on building rapport and professional presence.\n`;
                        if (area.key === 'explore') summary += `Diagnostic process requires development. Missing questions or failing to identify all concerns.\n`;
                        if (area.key === 'present') summary += `Solution presentation needs strengthening. Unclear options or unclear pricing confidence.\n`;
                        if (area.key === 'execute') summary += `Technical execution requires attention. Quality, efficiency, or cleanliness concerns noted.\n`;
                        if (area.key === 'wrapUp') summary += `Service conclusion inadequate. Not confirming satisfaction or requesting reviews/referrals.\n`;
                    });
                    summary += `\n`;
                }

                if (criticalAreas.length > 0) {
                    summary += `CRITICAL DEFICIENCIES\n`;
                    summary += `─────────────────────────────────────────────────────\n`;
                    criticalAreas.forEach(area => {
                        summary += `✖ ${area.step} (${area.avg}/5.0): IMMEDIATE TRAINING REQUIRED\n`;
                    });
                    summary += `\n`;
                }

                // Consistency Analysis
                summary += `CONSISTENCY ANALYSIS\n`;
                summary += `─────────────────────────────────────────────────────\n`;
                if (avgVariance < 0.5) {
                    summary += `${reviewData.technicianName} demonstrates excellent consistency across all service calls. Performance is reliable and predictable, indicating strong foundational skills and good self-management.\n\n`;
                } else if (avgVariance < 1.0) {
                    summary += `${reviewData.technicianName} shows reasonable consistency with some variation between calls. May perform differently under varying conditions (call complexity, customer type, time pressure). Focus on standardizing approach.\n\n`;
                } else {
                    summary += `CONSISTENCY CONCERN: Significant performance variation observed between calls. This inconsistency suggests:\n`;
                    summary += `• Incomplete mastery of core competencies\n`;
                    summary += `• Difficulty adapting to different situations\n`;
                    summary += `• Potential stress or focus issues\n`;
                    summary += `Recommendation: Implement structured checklist system to standardize approach.\n\n`;
                }

                // Strategic Recommendations
                summary += `STRATEGIC RECOMMENDATIONS\n`;
                summary += `─────────────────────────────────────────────────────\n`;
                
                const topPriority = stepAverages.sort((a, b) => a.avg - b.avg)[0];
                summary += `1. IMMEDIATE PRIORITY: Focus on ${topPriority.step} (currently ${topPriority.avg}/5.0)\n`;
                summary += `   ${getRecommendation(topPriority.key, Math.round(topPriority.avg))}\n\n`;

                if (overallAvg >= 4.0) {
                    summary += `2. LEVERAGE STRENGTHS: Use ${reviewData.technicianName}'s strong ${excellentAreas.concat(strongAreas).map(a => a.step).join(' and ')} skills as foundation for further development.\n\n`;
                    summary += `3. CAREER DEVELOPMENT: Consider advanced certification or specialization training to maximize potential.\n\n`;
                } else if (overallAvg >= 3.0) {
                    summary += `2. STRUCTURED DEVELOPMENT: Implement 60-day improvement plan with weekly milestones.\n\n`;
                    summary += `3. MENTORSHIP: Pair with high-performing technician for shadowing and coaching.\n\n`;
                } else {
                    summary += `2. INTENSIVE SUPPORT: Daily check-ins and supervised calls until core competencies improve.\n\n`;
                    summary += `3. EVALUATION TIMELINE: Reassess performance in 2 weeks. Consider alternative placement if insufficient progress.\n\n`;
                }

                // Next Steps
                summary += `IMMEDIATE NEXT STEPS\n`;
                summary += `─────────────────────────────────────────────────────\n`;
                summary += reviewData.nextSteps || 'No specific next steps documented.\n';
                summary += `\n\n`;

                summary += `═══════════════════════════════════════════════════════\n`;
                summary += `Review Completed By: [Manager Name]\n`;
                summary += `Technician Acknowledgment: ___________________________\n`;
                summary += `Date: _____________\n`;
                summary += `═══════════════════════════════════════════════════════\n`;

                return summary;
            };

            const completeReview = () => {
                if (reviewData.calls.length === 0) {
                    alert('Please add at least one service call before completing the review.');
                    return;
                }

                if (!reviewData.nextSteps) {
                    const confirmProceed = confirm('You have not entered any next steps. Do you want to complete the review anyway?');
                    if (!confirmProceed) return;
                }

                const finalSummary = generateFinalSummary();
                
                setReviewData({
                    ...reviewData,
                    completed: true,
                    completedAt: new Date().toISOString(),
                    finalSummary: finalSummary
                });

                alert('Review completed! The final summary has been generated and locked. You can now export the completed review.');
            };

            const unlockReview = () => {
                if (confirm('⚠️ UNLOCK REVIEW\n\nThis will unlock the review for editing. The final summary will be regenerated when you complete it again.\n\nDo you want to unlock this review?')) {
                    setReviewData({
                        ...reviewData,
                        completed: false,
                        completedAt: null,
                        finalSummary: ''
                    });
                    alert('✓ Review unlocked. You can now make edits.');
                }
            };

            const sendEmail = () => {
                try {
                    const subject = `Ride-Along Review: ${reviewData.technicianName} - ${reviewData.reviewDate}`;
                    
                    let body = '';
                    
                    if (reviewData.completed && reviewData.finalSummary) {
                        body = reviewData.finalSummary;
                    } else {
                        body = generateOverallSummary() + '\n\n' + 
                            reviewData.calls.map((call, i) => {
                                const review = generateCallReview(call);
                                let callText = `Call ${i + 1}: ${call.customerName}\nScore: ${review.avgScore === 'N/A' ? 'N/A' : review.avgScore + '/5.0'}\n${review.summary}\n`;
                                if (call.notes) callText += `Notes: ${call.notes}\n`;
                                if (call.nextStep) callText += `Next Step: ${call.nextStep}\n`;
                                return callText;
                            }).join('\n');
                        
                        if (reviewData.nextSteps) {
                            body += `\n\nOverall Next Steps:\n${reviewData.nextSteps}`;
                        }
                    }
                    
                    // Create mailto link
                    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    // Try to open email client
                    window.location.href = mailtoLink;
                    
                    // Inform user
                    setTimeout(() => {
                        alert('Your email client should open with the review content. If it doesn\'t open automatically, please check your default email client settings.');
                    }, 500);
                } catch (error) {
                    console.error('Email error:', error);
                    alert('Error creating email. Please try using the Download PDF option instead.');
                }
            };

            const saveReview = () => {
                if (!reviewData.technicianName) {
                    alert('Please enter technician name before saving.');
                    return;
                }

                const reviewToSave = {
                    ...reviewData,
                    id: reviewData.id || Date.now(),
                    savedAt: new Date().toISOString()
                };

                try {
                    // Save to savedReviews array
                    const saved = localStorage.getItem('savedReviews');
                    const reviews = saved ? JSON.parse(saved) : [];
                    
                    // Check if updating existing saved review
                    const existingIndex = reviews.findIndex(r => r.id === reviewToSave.id);
                    if (existingIndex >= 0) {
                        reviews[existingIndex] = reviewToSave;
                        console.log('Updated existing saved review');
                    } else {
                        reviews.push(reviewToSave);
                        console.log('Added new saved review');
                    }
                    
                    localStorage.setItem('savedReviews', JSON.stringify(reviews));
                    setSavedReviews(reviews);
                    
                    // Update current review in localStorage
                    localStorage.setItem('currentReview', JSON.stringify(reviewToSave));
                    
                    // Update reviewData state to include the ID
                    if (!reviewData.id) {
                        setReviewData(reviewToSave);
                    }
                    
                    // Sync to cloud if signed in
                    if (isSignedIn && cloudEnabled && isOnline) {
                        syncToCloud();
                    }
                    
                    console.log('Review saved:', reviewToSave);
                    alert(`✓ Review for ${reviewData.technicianName} saved successfully!`);
                } catch (error) {
                    console.error('Save error:', error);
                    alert('✗ Failed to save review: ' + error.message);
                }
            };

            const loadReview = (review) => {
                console.log('Loading review:', review);
                
                // Load ALL review data fields
                setReviewData({
                    technicianName: review.technicianName || '',
                    trainerName: review.trainerName || '',
                    reviewDate: review.reviewDate || new Date().toISOString().split('T')[0],
                    nextSteps: review.nextSteps || '',
                    calls: review.calls || [],
                    completed: review.completed || false,
                    completedAt: review.completedAt || null,
                    finalSummary: review.finalSummary || ''
                });
                
                setShowLoadModal(false);
                
                // Auto-edit first call to show checkboxes
                if (review.calls && review.calls.length > 0) {
                    setTimeout(() => {
                        editCall(review.calls[0]);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                }
                
                alert('Review loaded successfully! First call opened for editing.');
            };

            const deleteReview = (id) => {
                if (confirm('Are you sure you want to delete this saved review?')) {
                    const updated = savedReviews.filter(r => r.id !== id);
                    localStorage.setItem('savedReviews', JSON.stringify(updated));
                    setSavedReviews(updated);
                }
            };

            const newReview = () => {
                if (reviewData.calls.length > 0 || reviewData.technicianName) {
                    if (confirm('Start a new review? Current progress will be cleared (you can save it first).')) {
                        setReviewData({
                            technicianName: '',
                            trainerName: '',
                            reviewDate: new Date().toISOString().split('T')[0],
                            nextSteps: '',
                            calls: [],
                            completed: false,
                            completedAt: null,
                            finalSummary: ''
                        });
                        localStorage.removeItem('currentReview');
                    }
                } else {
                    setReviewData({
                        technicianName: '',
                        trainerName: '',
                        reviewDate: new Date().toISOString().split('T')[0],
                        nextSteps: '',
                        calls: [],
                        completed: false,
                        completedAt: null,
                        finalSummary: ''
                    });
                }
            };

            const loadLastSession = () => {
                const saved = localStorage.getItem('currentReview');
                if (saved) {
                    if (confirm('Load your last in-progress review?')) {
                        setReviewData(JSON.parse(saved));
                    }
                }
            };

            const updateTechnicianStats = () => {
                const stats = {...technicianStats};
                const techName = reviewData.technicianName;
                
                if (!stats[techName]) {
                    stats[techName] = {
                        totalRideAlongs: 0,
                        totalCalls: 0,
                        averageScore: 0,
                        reviews: [],
                        stepAverages: {
                            prepare: [],
                            greet: [],
                            explore: [],
                            present: [],
                            execute: [],
                            wrapUp: []
                        }
                    };
                }

                // Calculate scores from this review
                const allScores = reviewData.calls.flatMap(call => 
                    [call.prepare, call.greet, call.explore, call.present, call.execute, call.wrapUp]
                ).filter(score => score !== 'N/A' && score !== 0);

                const avgScore = allScores.length > 0 
                    ? (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1)
                    : 0;

                // Update step averages
                serviceSteps.forEach(step => {
                    const stepScores = reviewData.calls
                        .map(call => call[step.key])
                        .filter(score => score !== 'N/A' && score !== 0);
                    if (stepScores.length > 0) {
                        stats[techName].stepAverages[step.key].push(...stepScores);
                    }
                });

                stats[techName].totalRideAlongs += 1;
                stats[techName].totalCalls += reviewData.calls.length;
                stats[techName].reviews.push({
                    date: reviewData.reviewDate,
                    score: avgScore,
                    calls: reviewData.calls.length,
                    completedAt: reviewData.completedAt
                });

                // Recalculate overall average
                const allReviewScores = stats[techName].reviews.map(r => parseFloat(r.score)).filter(s => s > 0);
                stats[techName].averageScore = allReviewScores.length > 0
                    ? (allReviewScores.reduce((a, b) => a + b, 0) / allReviewScores.length).toFixed(1)
                    : 0;

                setTechnicianStats(stats);
                localStorage.setItem('technicianStats', JSON.stringify(stats));
            };

            const getTechnicianFolders = () => {
                const folders = {};
                savedReviews.forEach(review => {
                    const techName = review.technicianName;
                    const reviewDate = review.reviewDate;
                    
                    if (!folders[techName]) {
                        folders[techName] = {};
                    }
                    
                    if (!folders[techName][reviewDate]) {
                        folders[techName][reviewDate] = [];
                    }
                    
                    folders[techName][reviewDate].push(review);
                });
                return folders;
            };

            const getTechnicianScoringCard = (techName) => {
                const stats = technicianStats[techName];
                if (!stats) return null;

                const stepAvgs = {};
                serviceSteps.forEach(step => {
                    const scores = stats.stepAverages[step.key];
                    stepAvgs[step.label] = scores.length > 0
                        ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1)
                        : 'N/A';
                });

                return {
                    ...stats,
                    stepAverages: stepAvgs
                };
            };

            // Cloud Backup Functions
            const signInToCloud = async () => {
                if (!firebaseInitialized) {
                    alert('Cloud backup is not configured. Please add your Firebase configuration to enable this feature.');
                    return;
                }

                try {
                    setSyncStatus('Signing in...');
                    await auth.signInWithEmailAndPassword(userEmail, userPassword);
                    alert('Successfully signed in to cloud backup!');
                    setShowCloudSetup(false);
                    await syncToCloud();
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        // Try to create account
                        try {
                            await auth.createUserWithEmailAndPassword(userEmail, userPassword);
                            alert('Account created and signed in successfully!');
                            setShowCloudSetup(false);
                            await syncToCloud();
                        } catch (createError) {
                            alert('Error creating account: ' + createError.message);
                            setSyncStatus('');
                        }
                    } else {
                        alert('Sign in error: ' + error.message);
                        setSyncStatus('');
                    }
                }
            };

            const signOutFromCloud = async () => {
                if (firebaseInitialized && auth) {
                    try {
                        await auth.signOut();
                        setIsSignedIn(false);
                        setCloudEnabled(false);
                        alert('Signed out from cloud backup');
                    } catch (error) {
                        alert('Error signing out: ' + error.message);
                    }
                }
            };

            const syncToCloud = async () => {
                if (!firebaseInitialized || !isSignedIn || !db || !isOnline) {
                    console.log('Cloud backup not available (offline or not signed in)');
                    return;
                }

                try {
                    setSyncStatus('Syncing to cloud...');
                    const userId = auth.currentUser.uid;
                    const timestamp = new Date().toISOString();

                    // Save current review data (in-progress)
                    await db.collection('users').doc(userId).collection('current').doc('currentReview').set({
                        reviewData: reviewData,
                        updatedAt: timestamp
                    });

                    // Save all completed reviews with 5-file rotation
                    const reviewsCollection = db.collection('users').doc(userId).collection('reviews');
                    
                    // Get existing backup files
                    const backups = await reviewsCollection.orderBy('createdAt', 'desc').get();
                    const backupDocs = backups.docs;
                    
                    // If we have 5 or more backups, delete the oldest
                    if (backupDocs.length >= 5) {
                        const toDelete = backupDocs.slice(4); // Keep first 4, delete rest
                        for (const doc of toDelete) {
                            await doc.ref.delete();
                            console.log(`Deleted old backup: ${doc.id}`);
                        }
                    }
                    
                    // Create new backup with timestamp
                    await reviewsCollection.doc(`backup_${Date.now()}`).set({
                        reviews: savedReviews,
                        createdAt: timestamp,
                        updatedAt: timestamp
                    });

                    // Save stats
                    await db.collection('users').doc(userId).collection('stats').doc('technicianStats').set({
                        stats: technicianStats,
                        updatedAt: timestamp
                    });
                    
                    // Save custom checklists (serviceSteps)
                    await db.collection('users').doc(userId).collection('settings').doc('serviceSteps').set({
                        serviceSteps: serviceSteps,
                        checklistVersion: CHECKLIST_VERSION,
                        updatedAt: timestamp
                    });
                    
                    // Save technicians and trainers lists
                    await db.collection('users').doc(userId).collection('settings').doc('lists').set({
                        techniciansList: techniciansList,
                        trainersList: trainersList,
                        servicesList: servicesList,
                        updatedAt: timestamp
                    });

                    setLastCloudSync(timestamp);
                    setSyncStatus('✓ Synced to cloud');
                    setTimeout(() => setSyncStatus(''), 3000);
                    console.log('Cloud sync complete - 5-file rotation active');
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('✗ Sync failed: ' + error.message);
                    setTimeout(() => setSyncStatus(''), 5000);
                }
            };

            const loadFromCloud = async () => {
                if (!firebaseInitialized || !auth.currentUser || !db) {
                    return;
                }

                try {
                    setSyncStatus('Loading from cloud...');
                    const userId = auth.currentUser.uid;

                    // Load current review (in-progress)
                    const currentDoc = await db.collection('users').doc(userId).collection('current').doc('currentReview').get();
                    if (currentDoc.exists) {
                        const data = currentDoc.data();
                        if (data.reviewData) {
                            setReviewData(data.reviewData);
                            localStorage.setItem('currentReview', JSON.stringify(data.reviewData));
                            console.log('Loaded currentReview from cloud');
                        }
                    }

                    // Load reviews from most recent backup (NEW FORMAT)
                    const reviewsCollection = db.collection('users').doc(userId).collection('reviews');
                    const backupsSnapshot = await reviewsCollection.orderBy('createdAt', 'desc').limit(1).get();
                    
                    let reviewsLoaded = false;
                    
                    if (!backupsSnapshot.empty) {
                        const mostRecentBackup = backupsSnapshot.docs[0];
                        const data = mostRecentBackup.data();
                        setSavedReviews(data.reviews || []);
                        localStorage.setItem('savedReviews', JSON.stringify(data.reviews || []));
                        console.log('✓ Loaded savedReviews from NEW cloud backup:', mostRecentBackup.id, '- Reviews:', data.reviews?.length || 0);
                        reviewsLoaded = true;
                    } else {
                        console.log('No new backup files found, checking old format...');
                    }
                    
                    // MIGRATION: Check for OLD FORMAT (allReviews document)
                    if (!reviewsLoaded) {
                        const oldReviewsDoc = await reviewsCollection.doc('allReviews').get();
                        if (oldReviewsDoc.exists) {
                            const data = oldReviewsDoc.data();
                            setSavedReviews(data.reviews || []);
                            localStorage.setItem('savedReviews', JSON.stringify(data.reviews || []));
                            console.log('✓ MIGRATED savedReviews from OLD format:', data.reviews?.length || 0);
                            alert('📦 Found your previous save! Migrating to new backup system...');
                            
                            // Immediately save in new format
                            setTimeout(() => {
                                syncToCloud();
                            }, 1000);
                            reviewsLoaded = true;
                        } else {
                            console.log('No reviews found in cloud (old or new format)');
                        }
                    }

                    // Load stats
                    const statsDoc = await db.collection('users').doc(userId).collection('stats').doc('technicianStats').get();
                    if (statsDoc.exists) {
                        const data = statsDoc.data();
                        setTechnicianStats(data.stats || {});
                        localStorage.setItem('technicianStats', JSON.stringify(data.stats || {}));
                        console.log('Loaded technicianStats from cloud');
                    }
                    
                    // Load custom checklists (serviceSteps)
                    const serviceStepsDoc = await db.collection('users').doc(userId).collection('settings').doc('serviceSteps').get();
                    if (serviceStepsDoc.exists) {
                        const data = serviceStepsDoc.data();
                        if (data.serviceSteps) {
                            setServiceSteps(data.serviceSteps);
                            localStorage.setItem('serviceSteps', JSON.stringify(data.serviceSteps));
                            console.log('Loaded serviceSteps from cloud');
                        }
                        if (data.checklistVersion) {
                            localStorage.setItem('checklistVersion', data.checklistVersion);
                            console.log('Loaded checklistVersion from cloud:', data.checklistVersion);
                        }
                    }
                    
                    // Load technicians and trainers lists
                    const listsDoc = await db.collection('users').doc(userId).collection('settings').doc('lists').get();
                    if (listsDoc.exists) {
                        const data = listsDoc.data();
                        if (data.techniciansList) {
                            setTechniciansList(data.techniciansList);
                            localStorage.setItem('techniciansList', JSON.stringify(data.techniciansList));
                            console.log('Loaded techniciansList from cloud');
                        }
                        if (data.trainersList) {
                            setTrainersList(data.trainersList);
                            localStorage.setItem('trainersList', JSON.stringify(data.trainersList));
                            console.log('Loaded trainersList from cloud');
                        }
                        if (data.servicesList) {
                            setServicesList(data.servicesList);
                            localStorage.setItem('servicesList', JSON.stringify(data.servicesList));
                            console.log('Loaded servicesList from cloud');
                        }
                    }

                    setLastCloudSync(new Date().toISOString());
                    setSyncStatus('✓ Loaded from cloud');
                    setTimeout(() => setSyncStatus(''), 3000);
                    console.log('Cloud load complete - all data restored');
                } catch (error) {
                    console.error('Load error:', error);
                    setSyncStatus('✗ Load failed: ' + error.message);
                    setTimeout(() => setSyncStatus(''), 5000);
                }
            };

            // Auto-sync when data changes
            useEffect(() => {
                if (cloudEnabled && isSignedIn && savedReviews.length > 0) {
                    const timeoutId = setTimeout(() => {
                        syncToCloud();
                    }, 2000); // Debounce sync by 2 seconds
                    return () => clearTimeout(timeoutId);
                }
            }, [savedReviews, technicianStats, cloudEnabled, isSignedIn]);

            // Safety check - ensure currentCall is always defined
            if (!currentCall) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <p className="text-gray-600">Initializing...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-3 md:p-6">
                    {/* Load Modal */}
                    {showLoadModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-y-auto">
                                <div className="p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">Load Saved Review</h2>
                                        <button
                                            onClick={() => setShowLoadModal(false)}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    
                                    {savedReviews.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No saved reviews found.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {savedReviews.map(review => (
                                                <div key={review.id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            <h3 className="font-semibold text-gray-800">{review.technicianName}</h3>
                                                            <p className="text-sm text-gray-600">Date: {review.reviewDate}</p>
                                                            <p className="text-sm text-gray-600">Calls: {review.calls.length}</p>
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                Saved: {new Date(review.savedAt).toLocaleString()}
                                                            </p>
                                                            {review.completed && (
                                                                <span className="inline-block mt-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">
                                                                    ✓ Completed
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => loadReview(review)}
                                                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                                                            >
                                                                {review.completed ? 'View' : 'Load'}
                                                            </button>
                                                            {!review.completed && (
                                                                <button
                                                                    onClick={() => {
                                                                        loadReview(review);
                                                                        setShowLoadModal(false);
                                                                    }}
                                                                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                                                                >
                                                                    Edit
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => deleteReview(review.id)}
                                                                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto">
                        {/* Cloud Setup Modal */}
                        {/* Print Preview Modal */}
                        {showPrintPreview && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                                <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl my-8">
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold text-gray-800">🔍 Print Preview</h2>
                                            <button
                                                onClick={() => setShowPrintPreview(false)}
                                                className="text-gray-500 hover:text-gray-700 text-3xl leading-none"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        
                                        <div className="mb-4 bg-blue-50 border-l-4 border-blue-600 p-3">
                                            <p className="text-sm text-gray-700">
                                                <strong>Preview Mode:</strong> This shows how your report will print. 
                                                Click between calls to add page breaks, then click "Print Now".
                                            </p>
                                        </div>
                                        
                                        {/* Scrollable Preview Area */}
                                        <div className="border-2 border-gray-300 bg-gray-100 p-4 max-h-[500px] overflow-y-auto">
                                            <div className="bg-white shadow-lg mx-auto" style={{width: '8.5in', minHeight: '11in', padding: '0.4in', fontSize: '9pt'}}>
                                                
                                                {/* Header - Compact */}
                                                <div className="mb-4 pb-2 border-b-2 border-black">
                                                    <h1 className="text-sm font-bold text-center mb-2">Service Technician Ride-Along Review</h1>
                                                    <div className="grid grid-cols-4 gap-1 text-xs">
                                                        <div><strong>Tech:</strong> {reviewData.technicianName}</div>
                                                        <div><strong>Date:</strong> {reviewData.reviewDate}</div>
                                                        <div><strong>Calls:</strong> {reviewData.calls.length}</div>
                                                        <div><strong>Generated:</strong> {new Date().toLocaleDateString()}</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Calls */}
                                                {reviewData.calls.map((call, index) => {
                                                    const review = generateCallReview(call);
                                                    const hasPageBreakAfter = manualPageBreaks.includes(index + 1);
                                                    
                                                    return (
                                                        <div key={call.id}>
                                                            {/* Call Content */}
                                                            <div className="border border-gray-300 rounded p-2 mb-3 text-xs">
                                                                <h3 className="text-sm font-bold mb-1">
                                                                    Call {index + 1}: {call.customerName}
                                                                </h3>
                                                                
                                                                {(call.department || call.service || call.serviceType) && (
                                                                    <div className="text-xs text-gray-600">
                                                                        {call.department && call.service 
                                                                            ? `${call.department} - ${call.service}`
                                                                            : call.serviceType || call.department || call.service}
                                                                    </div>
                                                                )}
                                                                
                                                                <div className="flex items-center gap-3 my-1">
                                                                    <span className="font-bold">Avg: {review.avgScore}/5.0</span>
                                                                    <div className="flex gap-1 flex-wrap text-xs">
                                                                        {serviceSteps.map(step => (
                                                                            <span key={step.key} className="px-1 py-0.5 bg-gray-200 rounded">
                                                                                {step.label}: {call[step.key]}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="bg-gray-50 p-2 rounded my-2">
                                                                    <p className="text-xs">{review.summary}</p>
                                                                </div>
                                                                
                                                                {review.checklistDetails && (
                                                                    <div className="border border-gray-200 p-2 rounded">
                                                                        <strong className="text-xs">✓ Checklist Items:</strong>
                                                                        <pre className="text-xs mt-1 whitespace-pre-wrap font-sans">{review.checklistDetails}</pre>
                                                                    </div>
                                                                )}
                                                                
                                                                {call.notes && (
                                                                    <div className="text-xs italic mt-1">
                                                                        <strong>Notes:</strong> {call.notes}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Page Break Toggle Button - AFTER this call */}
                                                            {index < reviewData.calls.length - 1 && (
                                                                <>
                                                                    {hasPageBreakAfter && (
                                                                        <div className="my-3 border-t-4 border-dashed border-red-500 relative">
                                                                            <span className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">
                                                                                PAGE BREAK - Next call starts new page
                                                                            </span>
                                                                        </div>
                                                                    )}
                                                                    <button
                                                                        onClick={() => {
                                                                            if (hasPageBreakAfter) {
                                                                                setManualPageBreaks(manualPageBreaks.filter(b => b !== index + 1));
                                                                            } else {
                                                                                setManualPageBreaks([...manualPageBreaks, index + 1].sort((a,b) => a-b));
                                                                            }
                                                                        }}
                                                                        className={`w-full py-2 my-2 border-2 border-dashed rounded text-xs transition ${
                                                                            hasPageBreakAfter 
                                                                                ? 'border-red-500 bg-red-50 text-red-700 font-bold' 
                                                                                : 'border-gray-400 hover:border-blue-500 hover:bg-blue-50 text-gray-600 hover:text-blue-700'
                                                                        }`}
                                                                    >
                                                                        {hasPageBreakAfter ? `✓ PAGE BREAK AFTER CALL ${index + 1} - Click to Remove` : `+ Add Page Break After Call ${index + 1}`}
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                                
                                                {/* Overall Summary */}
                                                {reviewData.calls.length > 0 && (
                                                    <div className="mt-4 pt-3 border-t-2 border-gray-300">
                                                        <h2 className="text-sm font-bold mb-2">Overall Performance Summary</h2>
                                                        <p className="text-xs">{generateOverallSummary()}</p>
                                                        {reviewData.nextSteps && (
                                                            <div className="mt-2 p-2 bg-yellow-50 rounded">
                                                                <strong className="text-xs">Next Steps:</strong>
                                                                <p className="text-xs mt-1">{reviewData.nextSteps}</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Action Buttons */}
                                        <div className="flex gap-3 mt-4">
                                            <button
                                                onClick={() => setShowPrintPreview(false)}
                                                className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-md"
                                            >
                                                ← Back to Edit
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowPrintPreview(false);
                                                    setTimeout(() => {
                                                        // Apply page-break-after to call sections based on manual breaks
                                                        const callSections = document.querySelectorAll('.call-section');
                                                        callSections.forEach((el, idx) => {
                                                            // If there's a manual break after this call (idx+1), force page break
                                                            if (manualPageBreaks.includes(idx + 1)) {
                                                                el.style.pageBreakAfter = 'always';
                                                            } else {
                                                                el.style.pageBreakAfter = 'auto';
                                                            }
                                                        });
                                                        
                                                        // Print
                                                        window.print();
                                                        
                                                        // Reset after print
                                                        setTimeout(() => {
                                                            callSections.forEach((el) => {
                                                                el.style.pageBreakAfter = 'auto';
                                                            });
                                                        }, 1000);
                                                    }, 100);
                                                }}
                                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md"
                                            >
                                                🖨️ Print Now
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showCloudSetup && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800">☁️ Cloud Backup</h2>
                                        <button
                                            onClick={() => setShowCloudSetup(false)}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    
                                    {!isSignedIn ? (
                                        <div>
                                            <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                                                <p className="text-sm text-blue-800 mb-2">
                                                    <strong>Setup Required:</strong> To use cloud backup, you need to configure Firebase:
                                                </p>
                                                <ol className="text-xs text-blue-700 list-decimal ml-4 space-y-1">
                                                    <li>Go to <a href="https://console.firebase.google.com" target="_blank" className="underline">Firebase Console</a></li>
                                                    <li>Create a new project</li>
                                                    <li>Enable Authentication (Email/Password)</li>
                                                    <li>Enable Firestore Database</li>
                                                    <li>Copy your Firebase config</li>
                                                    <li>Replace the config in the HTML file</li>
                                                </ol>
                                            </div>
                                            
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Email
                                                    </label>
                                                    <input
                                                        type="email"
                                                        value={userEmail}
                                                        onChange={(e) => setUserEmail(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                        placeholder="your@email.com"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Password
                                                    </label>
                                                    <input
                                                        type="password"
                                                        value={userPassword}
                                                        onChange={(e) => setUserPassword(e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                        placeholder="••••••••"
                                                    />
                                                </div>
                                                <button
                                                    onClick={signInToCloud}
                                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                                    disabled={!firebaseInitialized}
                                                >
                                                    {firebaseInitialized ? 'Sign In / Create Account' : 'Firebase Not Configured'}
                                                </button>
                                                
                                                {!firebaseInitialized && (
                                                    <p className="text-xs text-red-600 text-center">
                                                        Please configure Firebase in the HTML file to enable cloud backup
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="mb-6 p-4 bg-green-50 rounded-lg">
                                                <p className="text-sm text-green-800">
                                                    ✓ <strong>Connected as:</strong> {userEmail}
                                                </p>
                                                {lastCloudSync && (
                                                    <p className="text-xs text-green-700 mt-2">
                                                        Last sync: {new Date(lastCloudSync).toLocaleString()}
                                                    </p>
                                                )}
                                            </div>
                                            
                                            <div className="space-y-3">
                                                <button
                                                    onClick={async () => {
                                                        await loadFromCloud();
                                                        alert('Data loaded from cloud!');
                                                    }}
                                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                                >
                                                    🔄 Refresh from Cloud
                                                </button>
                                                
                                                <button
                                                    onClick={async () => {
                                                        await syncToCloud();
                                                        alert('Data backed up to cloud!');
                                                    }}
                                                    className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                                >
                                                    ☁️ Backup Now
                                                </button>
                                                
                                                <button
                                                    onClick={signOutFromCloud}
                                                    className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                                >
                                                    Sign Out
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Checklist Editor Modal */}
                        {showChecklistEditor && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800">⚙️ Edit Checklists</h2>
                                            <button
                                                onClick={() => setShowChecklistEditor(false)}
                                                className="text-gray-500 hover:text-gray-700 text-2xl"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        
                                        <p className="text-gray-600 mb-4">
                                            Customize the checklist items for each service step. Changes are saved automatically.
                                        </p>
                                        
                                        {!serviceSteps || serviceSteps.length === 0 ? (
                                            <div className="text-center py-8">
                                                <p className="text-red-600 mb-4">Error: Service steps not loaded</p>
                                                <button
                                                    onClick={() => window.location.reload()}
                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md"
                                                >
                                                    Reload Page
                                                </button>
                                            </div>
                                        ) : (
                                            <>
                                                {serviceSteps.map((step, stepIdx) => (
                                            <div key={step.key} className="mb-6 border border-gray-200 rounded-lg p-4">
                                                <h3 className="text-lg font-bold text-gray-800 mb-2">{step.label}</h3>
                                                <p className="text-sm text-gray-600 mb-3">{step.description}</p>
                                                
                                                <div className="space-y-2">
                                                    {step.checklist.map((item, itemIdx) => (
                                                        <div key={itemIdx} className="flex items-center gap-2 group">
                                                            <div className="flex flex-col gap-1">
                                                                <button
                                                                    onClick={() => itemIdx > 0 && moveChecklistItem(step.key, itemIdx, itemIdx - 1)}
                                                                    disabled={itemIdx === 0}
                                                                    className="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed"
                                                                    title="Move up"
                                                                >
                                                                    ▲
                                                                </button>
                                                                <button
                                                                    onClick={() => itemIdx < step.checklist.length - 1 && moveChecklistItem(step.key, itemIdx, itemIdx + 1)}
                                                                    disabled={itemIdx === step.checklist.length - 1}
                                                                    className="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed"
                                                                    title="Move down"
                                                                >
                                                                    ▼
                                                                </button>
                                                            </div>
                                                            <input
                                                                type="text"
                                                                value={item}
                                                                onChange={(e) => updateChecklistItem(step.key, itemIdx, e.target.value)}
                                                                className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"
                                                                placeholder="Checklist item text"
                                                            />
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm('Delete this checklist item?')) {
                                                                        deleteChecklistItem(step.key, itemIdx);
                                                                    }
                                                                }}
                                                                className="text-red-500 hover:text-red-700 px-2 py-1"
                                                                title="Delete item"
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                <button
                                                    onClick={() => addChecklistItem(step.key)}
                                                    className="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm"
                                                >
                                                    ➕ Add Item
                                                </button>
                                            </div>
                                        ))}
                                        
                                        <div className="flex justify-between items-center mt-6 pt-6 border-t">
                                            <button
                                                onClick={resetToDefaults}
                                                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md"
                                            >
                                                🔄 Reset to Defaults
                                            </button>
                                            <button
                                                onClick={() => setShowChecklistEditor(false)}
                                                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium"
                                            >
                                                ✓ Done
                                            </button>
                                        </div>
                                    </>
                                )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Technician Folders Modal */}
                        {showTechnicianFolders && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800">Technician Folders & Scoring Cards</h2>
                                            <button
                                                onClick={() => {setShowTechnicianFolders(false); setSelectedTechnician(null);}}
                                                className="text-gray-500 hover:text-gray-700 text-2xl"
                                            >
                                                ×
                                            </button>
                                        </div>
                                        
                                        {!selectedTechnician ? (
                                            <div className="space-y-4">
                                                {Object.keys(getTechnicianFolders()).length === 0 ? (
                                                    <p className="text-gray-600 text-center py-8">No technician folders yet. Complete a review to create one.</p>
                                                ) : (
                                                    Object.entries(getTechnicianFolders()).map(([techName, dateGroups]) => {
                                                        const scoringCard = getTechnicianScoringCard(techName);
                                                        const totalReviews = Object.values(dateGroups).flat().length;
                                                        const uniqueDates = Object.keys(dateGroups).length;
                                                        
                                                        return (
                                                            <div key={techName} className="border border-gray-300 rounded-lg p-4 hover:bg-gray-50 cursor-pointer"
                                                                onClick={() => setSelectedTechnician(techName)}>
                                                                <div className="flex justify-between items-start mb-3">
                                                                    <div>
                                                                        <h3 className="text-xl font-bold text-gray-800">📁 {techName}</h3>
                                                                        <p className="text-sm text-gray-600">
                                                                            {uniqueDates} ride-along day{uniqueDates !== 1 ? 's' : ''} • {totalReviews} saved review{totalReviews !== 1 ? 's' : ''}
                                                                        </p>
                                                                    </div>
                                                                    {scoringCard && (
                                                                        <div className="text-right">
                                                                            <div className="text-2xl font-bold text-blue-600">{scoringCard.averageScore}/5.0</div>
                                                                            <div className="text-xs text-gray-600">Overall Average</div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                
                                                                {scoringCard && (
                                                                    <div className="bg-blue-50 rounded p-3 mb-3">
                                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                                                                            <div><strong>Total Ride-Alongs:</strong> {scoringCard.totalRideAlongs}</div>
                                                                            <div><strong>Total Calls:</strong> {scoringCard.totalCalls}</div>
                                                                            <div><strong>Avg Calls/Day:</strong> {(scoringCard.totalCalls / scoringCard.totalRideAlongs).toFixed(1)}</div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                <div className="text-sm text-blue-600 font-medium">
                                                                    Click to view full scoring card →
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        ) : (
                                            <div>
                                                <button 
                                                    onClick={() => setSelectedTechnician(null)}
                                                    className="text-blue-600 hover:text-blue-800 mb-4 flex items-center gap-2"
                                                >
                                                    ← Back to All Technicians
                                                </button>
                                                
                                                <div className="bg-white border-2 border-blue-500 rounded-lg p-6 mb-6">
                                                    <h3 className="text-2xl font-bold text-gray-800 mb-4">📊 Scoring Card: {selectedTechnician}</h3>
                                                    
                                                    {getTechnicianScoringCard(selectedTechnician) && (() => {
                                                        const card = getTechnicianScoringCard(selectedTechnician);
                                                        return (
                                                            <>
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                                                    <div className="bg-blue-100 p-4 rounded text-center">
                                                                        <div className="text-3xl font-bold text-blue-600">{card.averageScore}</div>
                                                                        <div className="text-sm text-gray-700">Overall Average</div>
                                                                    </div>
                                                                    <div className="bg-green-100 p-4 rounded text-center">
                                                                        <div className="text-3xl font-bold text-green-600">{card.totalRideAlongs}</div>
                                                                        <div className="text-sm text-gray-700">Ride-Alongs</div>
                                                                    </div>
                                                                    <div className="bg-purple-100 p-4 rounded text-center">
                                                                        <div className="text-3xl font-bold text-purple-600">{card.totalCalls}</div>
                                                                        <div className="text-sm text-gray-700">Total Calls</div>
                                                                    </div>
                                                                    <div className="bg-orange-100 p-4 rounded text-center">
                                                                        <div className="text-3xl font-bold text-orange-600">{(card.totalCalls / card.totalRideAlongs).toFixed(1)}</div>
                                                                        <div className="text-sm text-gray-700">Calls/Day</div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <h4 className="font-bold text-lg mb-3">Service Step Averages</h4>
                                                                <div className="space-y-2 mb-6">
                                                                    {Object.entries(card.stepAverages).map(([step, avg]) => (
                                                                        <div key={step} className="flex justify-between items-center">
                                                                            <span className="font-medium">{step}:</span>
                                                                            <div className="flex items-center gap-2">
                                                                                <div className="w-48 bg-gray-200 rounded-full h-4">
                                                                                    <div 
                                                                                        className={`h-4 rounded-full ${avg !== 'N/A' && parseFloat(avg) >= 4 ? 'bg-green-500' : avg !== 'N/A' && parseFloat(avg) >= 3 ? 'bg-yellow-500' : 'bg-red-500'}`}
                                                                                        style={{width: avg !== 'N/A' ? `${(parseFloat(avg) / 5) * 100}%` : '0%'}}
                                                                                    ></div>
                                                                                </div>
                                                                                <span className="font-bold w-12 text-right">{avg !== 'N/A' ? `${avg}/5` : 'N/A'}</span>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                                
                                                                <h4 className="font-bold text-lg mb-3">Review History</h4>
                                                                <div className="space-y-2">
                                                                    {card.reviews.map((review, idx) => (
                                                                        <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                                            <div>
                                                                                <div className="font-medium">{review.date}</div>
                                                                                <div className="text-xs text-gray-600">{review.calls} calls - {new Date(review.completedAt).toLocaleString()}</div>
                                                                            </div>
                                                                            <div className="text-lg font-bold text-blue-600">{review.score}/5.0</div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                                
                                                <h4 className="font-bold text-lg mb-3">Saved Reviews by Date</h4>
                                                <div className="space-y-4">
                                                    {Object.entries(getTechnicianFolders()[selectedTechnician] || {}).sort((a, b) => new Date(b[0]) - new Date(a[0])).map(([date, reviews]) => (
                                                        <div key={date} className="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                                                            <h5 className="font-bold text-lg text-gray-800 mb-3">📅 {date}</h5>
                                                            <div className="space-y-2">
                                                                {reviews.map(review => (
                                                                    <div key={review.id} className="border border-gray-200 bg-white rounded-lg p-3">
                                                                        <div className="flex justify-between items-start">
                                                                            <div className="flex-1">
                                                                                <div className="font-semibold">Review - {review.calls.length} calls</div>
                                                                                <p className="text-xs text-gray-500 mt-1">
                                                                                    Saved: {new Date(review.savedAt).toLocaleString()}
                                                                                </p>
                                                                                {review.completed && (
                                                                                    <span className="inline-block mt-1 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                                                                        ✓ Completed
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                            <div className="flex gap-2">
                                                                                <button
                                                                                    onClick={() => {loadReview(review); setShowTechnicianFolders(false); setSelectedTechnician(null);}}
                                                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                                                                                >
                                                                                    Load
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => deleteReview(review.id)}
                                                                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium"
                                                                                >
                                                                                    Delete
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Print-only Header */}
                        <div className="print-only bg-white p-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-4 text-center">Service Technician Ride-Along Review</h1>
                            <div className="grid grid-cols-2 gap-4 text-lg">
                                <div><strong>Technician:</strong> {reviewData.technicianName}</div>
                                <div><strong>Date:</strong> {reviewData.reviewDate}</div>
                                <div><strong>Total Calls:</strong> {reviewData.calls.length}</div>
                                <div><strong>Report Generated:</strong> {new Date().toLocaleDateString()}</div>
                            </div>
                        </div>

                        {/* Header with Action Buttons */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
                            <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Service Technician Ride-Along Review</h1>
                                <div className="flex flex-wrap gap-2 w-full md:w-auto">
                                    <button
                                        onClick={newReview}
                                        className="bg-gray-600 hover:bg-gray-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none"
                                    >
                                        🆕 New Review
                                    </button>
                                    <button
                                        onClick={() => {
                                            console.log('Edit Checklists clicked, serviceSteps:', serviceSteps);
                                            setShowChecklistEditor(true);
                                        }}
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none"
                                    >
                                        ⚙️ Edit Checklists
                                    </button>
                                    <button
                                        onClick={() => setShowTechnicianFolders(true)}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none"
                                    >
                                        📁 Technician Folders
                                    </button>
                                    <a
                                        href="dashboard.html"
                                        target="_blank"
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none text-center inline-block"
                                    >
                                        📊 Dashboard
                                    </a>
                                    <button
                                        onClick={() => setShowLoadModal(true)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none"
                                    >
                                        📂 Load Saved
                                    </button>
                                    <button
                                        onClick={saveReview}
                                        className="bg-green-600 hover:bg-green-700 text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none"
                                    >
                                        💾 Save Progress
                                    </button>
                                    <button
                                        onClick={() => setShowCloudSetup(true)}
                                        className={`${
                                            !isOnline ? 'bg-gray-500' :
                                            isSignedIn ? 'bg-teal-600 hover:bg-teal-700' : 'bg-orange-600 hover:bg-orange-700'
                                        } text-white px-3 md:px-4 py-2 rounded-md font-medium text-sm flex-1 md:flex-none`}
                                    >
                                        {!isOnline ? '📵 Offline' : isSignedIn ? '☁️ Cloud: ON' : '☁️ Cloud Backup'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Cloud Status Bar */}
                            {syncStatus && (
                                <div className={`mb-4 p-2 rounded text-sm text-center ${
                                    syncStatus.includes('✓') ? 'bg-green-100 text-green-800' : 
                                    syncStatus.includes('✗') ? 'bg-red-100 text-red-800' : 
                                    'bg-blue-100 text-blue-800'
                                }`}>
                                    {syncStatus}
                                    {lastCloudSync && syncStatus.includes('✓') && (
                                        <span className="ml-2 text-xs">
                                            (Last sync: {new Date(lastCloudSync).toLocaleTimeString()})
                                        </span>
                                    )}
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Technician Name *
                                    </label>
                                    <div className="flex gap-2">
                                        <select
                                            value={reviewData.technicianName}
                                            onChange={(e) => {
                                                if (e.target.value === '+ADD') {
                                                    setShowAddTechnician(true);
                                                } else {
                                                    setReviewData({...reviewData, technicianName: e.target.value});
                                                }
                                            }}
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">Select technician</option>
                                            {techniciansList.map(tech => (
                                                <option key={tech} value={tech}>{tech}</option>
                                            ))}
                                            <option value="+ADD">+ Add New Technician</option>
                                        </select>
                                        <button
                                            onClick={() => setShowAddTechnician(true)}
                                            className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap"
                                            title="Add new technician"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Select from list or add new</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Service Trainer *
                                    </label>
                                    <div className="flex gap-2">
                                        <select
                                            value={reviewData.trainerName}
                                            onChange={(e) => {
                                                if (e.target.value === '+ADD') {
                                                    setShowAddTrainer(true);
                                                } else {
                                                    setReviewData({...reviewData, trainerName: e.target.value});
                                                }
                                            }}
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">Select trainer</option>
                                            {trainersList.map(trainer => (
                                                <option key={trainer} value={trainer}>{trainer}</option>
                                            ))}
                                            <option value="+ADD">+ Add New Trainer</option>
                                        </select>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Can be edited anytime</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Review Date *
                                    </label>
                                    <input
                                        type="date"
                                        value={reviewData.reviewDate}
                                        onChange={(e) => setReviewData({...reviewData, reviewDate: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Can be edited anytime</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Start Time
                                    </label>
                                    <input
                                        type="time"
                                        value={reviewData.reviewStartTime}
                                        onChange={(e) => setReviewData({...reviewData, reviewStartTime: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Ride-along start</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Finish Time
                                    </label>
                                    <input
                                        type="time"
                                        value={reviewData.reviewFinishTime}
                                        onChange={(e) => setReviewData({...reviewData, reviewFinishTime: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Ride-along finish</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Total Calls
                                    </label>
                                    <div className="px-3 py-2 bg-gray-100 rounded-md text-lg font-semibold text-gray-700">
                                        {reviewData.calls.length}
                                    </div>
                                    {reviewData.reviewStartTime && reviewData.reviewFinishTime && (() => {
                                        const duration = calculateCallDuration(
                                            `2000-01-01T${reviewData.reviewStartTime}`,
                                            `2000-01-01T${reviewData.reviewFinishTime}`
                                        );
                                        return duration ? (
                                            <p className="text-xs text-gray-600 mt-1">Duration: {duration}</p>
                                        ) : null;
                                    })()}
                                </div>
                            </div>
                            
                            {/* Add Trainer Modal */}
                            {showAddTrainer && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">Add New Trainer</h3>
                                        <input
                                            type="text"
                                            value={newTrainerName}
                                            onChange={(e) => setNewTrainerName(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mb-4"
                                            placeholder="Enter trainer name (e.g., John D.)"
                                            autoFocus
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && newTrainerName.trim()) {
                                                    const updated = [...trainersList, newTrainerName.trim()];
                                                    setTrainersList(updated);
                                                    localStorage.setItem('trainersList', JSON.stringify(updated));
                                                    setReviewData({...reviewData, trainerName: newTrainerName.trim()});
                                                    setNewTrainerName('');
                                                    setShowAddTrainer(false);
                                                }
                                            }}
                                        />
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    if (newTrainerName.trim()) {
                                                        const updated = [...trainersList, newTrainerName.trim()];
                                                        setTrainersList(updated);
                                                        localStorage.setItem('trainersList', JSON.stringify(updated));
                                                        setReviewData({...reviewData, trainerName: newTrainerName.trim()});
                                                        setNewTrainerName('');
                                                        setShowAddTrainer(false);
                                                    }
                                                }}
                                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium"
                                            >
                                                Add Trainer
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setNewTrainerName('');
                                                    setShowAddTrainer(false);
                                                }}
                                                className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md font-medium"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Add Technician Modal */}
                            {showAddTechnician && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">Add New Technician</h3>
                                        <input
                                            type="text"
                                            value={newTechnicianName}
                                            onChange={(e) => setNewTechnicianName(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mb-4"
                                            placeholder="Enter technician name (e.g., John Smith)"
                                            autoFocus
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && newTechnicianName.trim()) {
                                                    const updated = [...techniciansList, newTechnicianName.trim()];
                                                    setTechniciansList(updated);
                                                    localStorage.setItem('techniciansList', JSON.stringify(updated));
                                                    setReviewData({...reviewData, technicianName: newTechnicianName.trim()});
                                                    setNewTechnicianName('');
                                                    setShowAddTechnician(false);
                                                }
                                            }}
                                        />
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    if (newTechnicianName.trim()) {
                                                        const updated = [...techniciansList, newTechnicianName.trim()];
                                                        setTechniciansList(updated);
                                                        localStorage.setItem('techniciansList', JSON.stringify(updated));
                                                        setReviewData({...reviewData, technicianName: newTechnicianName.trim()});
                                                        setNewTechnicianName('');
                                                        setShowAddTechnician(false);
                                                    }
                                                }}
                                                className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium"
                                            >
                                                Add Technician
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setNewTechnicianName('');
                                                    setShowAddTechnician(false);
                                                }}
                                                className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md font-medium"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Add Service Modal */}
                            {showAddService && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                        <h3 className="text-lg font-bold text-gray-800 mb-4">Add New Service</h3>
                                        <input
                                            type="text"
                                            value={newServiceName}
                                            onChange={(e) => setNewServiceName(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 mb-4"
                                            placeholder="Enter service name (e.g., Maintenance)"
                                            autoFocus
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && newServiceName.trim()) {
                                                    const updated = [...servicesList, newServiceName.trim()];
                                                    setServicesList(updated);
                                                    localStorage.setItem('servicesList', JSON.stringify(updated));
                                                    setCurrentCall({...currentCall, service: newServiceName.trim()});
                                                    setNewServiceName('');
                                                    setShowAddService(false);
                                                }
                                            }}
                                        />
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    if (newServiceName.trim()) {
                                                        const updated = [...servicesList, newServiceName.trim()];
                                                        setServicesList(updated);
                                                        localStorage.setItem('servicesList', JSON.stringify(updated));
                                                        setCurrentCall({...currentCall, service: newServiceName.trim()});
                                                        setNewServiceName('');
                                                        setShowAddService(false);
                                                    }
                                                }}
                                                className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium"
                                            >
                                                Add Service
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setNewServiceName('');
                                                    setShowAddService(false);
                                                }}
                                                className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md font-medium"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Current Call Entry */}
                        {!reviewData.completed && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
                                {editingCallId && (
                                    <div className="bg-yellow-100 border-2 border-yellow-500 rounded-lg p-4 mb-4">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">✏️</span>
                                            <div>
                                                <h3 className="text-lg font-bold text-yellow-900">Edit Mode Active</h3>
                                                <p className="text-sm text-yellow-800">
                                                    You are editing an existing call. Make your changes and click "Update Call" to save.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                                    <h2 className="text-xl md:text-2xl font-bold text-gray-800">
                                        {editingCallId ? '✏️ Edit Service Call' : 'Add Service Call'}
                                    </h2>
                                    {editingCallId && (
                                        <button
                                            onClick={cancelEdit}
                                            className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium text-sm"
                                        >
                                            Cancel Edit
                                        </button>
                                    )}
                                </div>
                            
                            {/* Customer Info */}
                            {showLoadCustomerButton && lastCustomer && (
                                <div className="mb-4 bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-blue-800">Previous customer: {lastCustomer.customerName}</p>
                                            <p className="text-xs text-blue-600">{lastCustomer.customerCity}</p>
                                        </div>
                                        <button
                                            onClick={loadPreviousCustomer}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition"
                                        >
                                            Load Previous Customer
                                        </button>
                                    </div>
                                </div>
                            )}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Customer Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={currentCall.customerName || ''}
                                        onChange={(e) => {
                                            try {
                                                if (!currentCall) return;
                                                setCurrentCall({...currentCall, customerName: e.target.value});
                                                if (showLoadCustomerButton) setShowLoadCustomerButton(false);
                                            } catch (error) {
                                                console.error('Error updating customerName:', error);
                                            }
                                        }}
                                        className={`w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 ${
                                            showDuplicateWarning 
                                                ? 'border-orange-400 bg-orange-50' 
                                                : 'border-gray-300'
                                        }`}
                                        placeholder="Enter customer name"
                                    />
                                    {showDuplicateWarning && (
                                        <p className="text-xs text-orange-600 mt-1 flex items-center gap-1">
                                            ⚠️ Similar customer name exists
                                        </p>
                                    )}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Department
                                    </label>
                                    <select
                                        value={currentCall.department || ''}
                                        onChange={(e) => setCurrentCall({...currentCall, department: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="">Select department</option>
                                        {departmentsList.map(dept => (
                                            <option key={dept} value={dept}>{dept}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Service
                                    </label>
                                    <div className="flex gap-2">
                                        <select
                                            value={currentCall.service || ''}
                                            onChange={(e) => {
                                                if (e.target.value === '+ADD') {
                                                    setShowAddService(true);
                                                } else {
                                                    setCurrentCall({...currentCall, service: e.target.value});
                                                }
                                            }}
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">Select service</option>
                                            {servicesList.map(svc => (
                                                <option key={svc} value={svc}>{svc}</option>
                                            ))}
                                            <option value="+ADD">+ Add New Service</option>
                                        </select>
                                        <button
                                            onClick={() => setShowAddService(true)}
                                            className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap"
                                            title="Add new service"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        City
                                    </label>
                                    <input
                                        type="text"
                                        value={currentCall.customerCity || ''}
                                        onChange={(e) => {
                                            setCurrentCall({...currentCall, customerCity: e.target.value});
                                            if (showLoadCustomerButton) setShowLoadCustomerButton(false);
                                        }}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter city"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Start Time
                                    </label>
                                    <input
                                        type="datetime-local"
                                        value={currentCall.startTime || ''}
                                        onChange={(e) => setCurrentCall({...currentCall, startTime: e.target.value || ''})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">When technician arrived</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Finish Time
                                    </label>
                                    <input
                                        type="datetime-local"
                                        value={currentCall.finishTime || ''}
                                        onChange={(e) => setCurrentCall({...currentCall, finishTime: e.target.value || ''})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">When technician left</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Call Duration
                                    </label>
                                    <div className="w-full px-3 py-3 border border-gray-300 rounded-md bg-gray-50">
                                        <div className="text-lg font-semibold text-gray-800">
                                            {(() => {
                                                const duration = calculateCallDuration(currentCall.startTime, currentCall.finishTime);
                                                return duration || '—';
                                            })()}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {currentCall.startTime && currentCall.finishTime 
                                                ? 'Calculated from start and finish times' 
                                                : 'Enter start and finish times above'}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Rating Grid */}
                            <div className="space-y-6 mb-6">
                                {serviceSteps.map(step => (
                                    <div key={step.key} className="border-b border-gray-200 pb-4">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <h3 className="text-lg font-semibold text-gray-800">{step.label}</h3>
                                                <p className="text-sm text-gray-600">{step.description}</p>
                                                
                                                {/* Interactive Checklist */}
                                                <details open className="mt-2">
                                                    <summary className="text-xs text-blue-600 hover:text-blue-800 cursor-pointer font-medium mb-2">
                                                        ☑ Checklist ({step.checklist.length} items) - Check all that apply
                                                    </summary>
                                                    <div className="mt-2 space-y-1 bg-gray-50 p-2 rounded">
                                                        {step.checklist.map((item, idx) => {
                                                            const isChecked = !!(currentCall.checklists && currentCall.checklists[step.key] && currentCall.checklists[step.key][idx]);
                                                            const isNA = !!(currentCall.checklistNA && currentCall.checklistNA[step.key] && currentCall.checklistNA[step.key][idx]);
                                                            return (
                                                                <div key={idx} className={`flex items-start p-1 rounded ${isNA ? 'bg-gray-200' : ''}`}>
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isChecked}
                                                                        disabled={isNA}
                                                                        onChange={(e) => {
                                                                            e.stopPropagation();
                                                                            console.log('Checkbox clicked:', step.key, idx, 'Current state:', isChecked);
                                                                            toggleChecklistItem(step.key, idx);
                                                                        }}
                                                                        className="mt-0.5 mr-2 h-4 w-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 disabled:opacity-50 cursor-pointer"
                                                                    />
                                                                    <span className={`text-xs flex-1 ${isNA ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{item}</span>
                                                                    <button
                                                                        type="button"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            toggleNA(step.key, idx);
                                                                        }}
                                                                        className={`ml-2 px-2 py-0.5 text-xs rounded font-medium ${
                                                                            isNA 
                                                                                ? 'bg-orange-500 text-white hover:bg-orange-600' 
                                                                                : 'bg-gray-300 text-gray-700 hover:bg-gray-400'
                                                                        }`}
                                                                        title={isNA ? 'Mark as applicable' : 'Mark as N/A'}
                                                                    >
                                                                        {isNA ? 'N/A' : 'N/A?'}
                                                                    </button>
                                                                </div>
                                                            );
                                                        })}
                                                        <p className="text-xs text-gray-500 mt-2 italic">
                                                            ⭐ Score based on % complete (N/A items excluded): 100%=5★, 80%+=4★, 60%+=3★, 40%+=2★, 20%+=1★
                                                        </p>
                                                    </div>
                                                </details>
                                            </div>
                                            <div className="text-right ml-4">
                                                <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                    currentCall[step.key] === 'N/A' 
                                                        ? 'bg-gray-400 text-white' 
                                                        : getRatingColor(currentCall[step.key] || 0)
                                                }`}>
                                                    {!currentCall[step.key] || currentCall[step.key] === 0 ? 'Not Rated' : currentCall[step.key] === 'N/A' ? 'N/A' : `${currentCall[step.key]}/5`}
                                                </span>
                                                <div className="text-xs text-gray-600 mt-1">
                                                    {currentCall[step.key] === 'N/A' ? 'Not Applicable' : getRatingText(currentCall[step.key] || 0)}
                                                </div>
                                                <div className="text-xs text-blue-600 mt-1 font-medium">
                                                    {currentCall.checklists && currentCall.checklists[step.key] && (() => {
                                                        const checked = currentCall.checklists[step.key].filter(x => x).length;
                                                        const total = step.checklist.length;
                                                        const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
                                                        return `${checked}/${total} (${percentage}%)`;
                                                    })()}
                                                </div>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500 italic mt-2 mb-1">Or manually override score:</p>
                                        <div className="flex gap-1 md:gap-2 rating-grid">
                                            <button
                                                onClick={() => {
                                                    try {
                                                        if (!currentCall) return;
                                                        setCurrentCall({...currentCall, [step.key]: 'N/A'});
                                                    } catch (error) {
                                                        console.error('Error setting N/A:', error);
                                                    }
                                                }}
                                                className={`rating-button px-2 md:px-4 py-3 rounded-md font-semibold text-sm md:text-base ${
                                                    currentCall[step.key] === 'N/A'
                                                        ? 'bg-gray-400 text-white'
                                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                            >
                                                N/A
                                            </button>
                                            {[1, 2, 3, 4, 5].map(rating => (
                                                <button
                                                    key={rating}
                                                    onClick={() => {
                                                        try {
                                                            if (!currentCall) return;
                                                            setCurrentCall({...currentCall, [step.key]: rating});
                                                        } catch (error) {
                                                            console.error('Error setting rating:', error);
                                                        }
                                                    }}
                                                    className={`rating-button flex-1 py-3 rounded-md font-semibold text-base md:text-lg ${
                                                        currentCall[step.key] === rating
                                                            ? getRatingColor(rating)
                                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {rating}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Notes */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Call Notes
                                </label>
                                <textarea
                                    value={currentCall.notes || ''}
                                    onChange={(e) => {
                                        try {
                                            if (!currentCall) {
                                                console.error('currentCall is undefined');
                                                return;
                                            }
                                            setCurrentCall({...currentCall, notes: e.target.value});
                                        } catch (error) {
                                            console.error('Error updating notes:', error);
                                        }
                                    }}
                                    rows="3"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    placeholder="Additional observations, specific incidents, training opportunities..."
                                />
                            </div>

                            {/* AI-Generated Review - Manual Trigger Only */}
                            {currentCall.prepare > 0 && (
                                <div className="mb-4">
                                    <button
                                        onClick={() => {
                                            try {
                                                if (!currentCall.customerName || !currentCall.customerName.trim()) {
                                                    alert('Please enter customer name first.');
                                                    return;
                                                }
                                                if (currentCall.prepare === 0) {
                                                    alert('Please rate all service steps before generating AI review.');
                                                    return;
                                                }
                                                
                                                // Inline AI generation logic
                                                const scores = [currentCall.prepare, currentCall.greet, currentCall.explore, currentCall.present, currentCall.execute, currentCall.wrapUp].filter(s => s !== 'N/A' && s !== 0);
                                                const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
                                                
                                                const timestamp = currentCall.callTime || new Date().toISOString().slice(0, 16);
                                                let dateStr = 'today';
                                                let timeStr = '';
                                                try {
                                                    const date = new Date(timestamp);
                                                    if (!isNaN(date.getTime())) {
                                                        dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                                                        timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                                    }
                                                } catch (e) {}
                                                
                                                let review = `I rode along on a service call to ${currentCall.customerName} on ${dateStr}${timeStr ? ' at ' + timeStr : ''}. `;
                                                
                                                if (avgScore >= 4.5) review += 'The technician performed exceptionally well across the board. ';
                                                else if (avgScore >= 4.0) review += 'The technician did a solid job overall. ';
                                                else if (avgScore >= 3.0) review += 'The technician met basic standards but has room to improve. ';
                                                else review += 'This call revealed significant gaps that need immediate attention. ';
                                                
                                                review += `Overall score: ${avgScore}/5.0.\n\n`;
                                                
                                                if (currentCall.notes) review += `${currentCall.notes}\n\n`;
                                                
                                                const areas = [];
                                                if (currentCall.prepare >= 5) areas.push('came fully prepared');
                                                if (currentCall.greet >= 5) areas.push('made a great first impression');
                                                if (currentCall.explore >= 5) areas.push('did thorough diagnostics');
                                                if (currentCall.present >= 5) areas.push('presented solutions clearly');
                                                if (currentCall.execute >= 5) areas.push('executed work flawlessly');
                                                if (currentCall.wrapUp >= 5) areas.push('wrapped up professionally');
                                                
                                                if (areas.length > 0) {
                                                    review += 'Strengths: The technician ' + areas.join(', ') + '.\n\n';
                                                }
                                                
                                                const needsWork = [];
                                                if (currentCall.prepare <= 2 && currentCall.prepare !== 0) needsWork.push('preparation');
                                                if (currentCall.greet <= 2 && currentCall.greet !== 0) needsWork.push('customer greeting');
                                                if (currentCall.explore <= 2 && currentCall.explore !== 0) needsWork.push('exploration');
                                                if (currentCall.present <= 2 && currentCall.present !== 0) needsWork.push('solution presentation');
                                                if (currentCall.execute <= 2 && currentCall.execute !== 0) needsWork.push('work execution');
                                                if (currentCall.wrapUp <= 2 && currentCall.wrapUp !== 0) needsWork.push('service wrap-up');
                                                
                                                if (needsWork.length > 0) {
                                                    review += 'Areas for development: ' + needsWork.join(', ') + '.\n\n';
                                                }
                                                
                                                review += 'Recommendations: ';
                                                if (avgScore >= 4.5) review += 'Continue excellent performance. Consider for lead technician role.';
                                                else if (avgScore >= 4.0) review += 'Continue current trajectory with minor refinements in identified areas.';
                                                else if (avgScore >= 3.0) review += 'Schedule weekly coaching sessions. Focus on growth opportunities.';
                                                else review += 'Immediate coaching required. Daily supervision recommended.';
                                                
                                                setCurrentCall({...currentCall, notes: review});
                                                alert('AI review generated! You can edit it in the notes field.');
                                            } catch (error) {
                                                console.error('Error generating AI review:', error);
                                                alert('Error generating AI review: ' + error.message);
                                            }
                                        }}
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium"
                                    >
                                        ✨ Generate AI Review
                                    </button>
                                    <p className="text-xs text-gray-500 mt-1">Click to generate AI-powered notes based on ratings</p>
                                </div>
                            )}

                            {/* Next Step */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Next Step for This Call
                                </label>
                                <input
                                    type="text"
                                    value={currentCall.nextStep || ''}
                                    onChange={(e) => setCurrentCall({...currentCall, nextStep: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                    placeholder="Follow-up training, specific coaching needed, etc."
                                />
                            </div>

                            {/* Helper Buttons */}
                            {currentCall.prepare > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                    <button
                                        onClick={() => {
                                            try {
                                                const review = generateCallReview({...currentCall, timestamp: currentCall.callTime || new Date().toISOString()});
                                                const newNotes = currentCall.notes ? `${currentCall.notes}\n\n--- Call Review ---\n${review.summary}\nAverage Score: ${review.avgScore}/5.0` : `--- Call Review ---\n${review.summary}\nAverage Score: ${review.avgScore}/5.0`;
                                                setCurrentCall({...currentCall, notes: newNotes});
                                            } catch (error) {
                                                console.error('Error:', error);
                                                alert('Error: ' + error.message);
                                            }
                                        }}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium text-sm"
                                    >
                                        📝 Add Call Review to Notes
                                    </button>
                                    <button
                                        onClick={() => {
                                            try {
                                                const recs = generateRecommendations(currentCall);
                                                if (recs.length === 0) {
                                                    alert('No recommendations - all areas scored well!');
                                                    return;
                                                }
                                                const recText = recs.map(r => `[${r.priority}] ${r.area}: ${r.recommendation}`).join('\n\n');
                                                const newNextStep = currentCall.nextStep ? `${currentCall.nextStep}\n\n${recText}` : recText;
                                                setCurrentCall({...currentCall, nextStep: newNextStep});
                                            } catch (error) {
                                                console.error('Error:', error);
                                                alert('Error: ' + error.message);
                                            }
                                        }}
                                        className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded font-medium text-sm"
                                    >
                                        💡 Add Recommendations
                                    </button>
                                </div>
                            )}

                            <button
                                onClick={addCall}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition duration-200"
                            >
                                {editingCallId ? '✓ Update Call' : 'Add Call to Review'}
                            </button>
                        </div>
                        )}

                        {/* Completed Calls */}
                        {reviewData.calls.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Completed Calls ({reviewData.calls.length})</h2>
                                <div className="space-y-4">
                                    {reviewData.calls.map((call, index) => {
                                        const review = generateCallReview(call);
                                        const isBeingEdited = editingCallId === call.id;
                                        return (
                                            <div key={call.id} className={`border rounded-lg p-4 call-section ${isBeingEdited ? 'border-blue-500 border-2 bg-blue-50' : 'border-gray-200'}`}>
                                                {isBeingEdited && (
                                                    <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold inline-block mb-2">
                                                        EDITING THIS CALL ↑
                                                    </div>
                                                )}
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h3 className="text-base md:text-lg font-semibold text-gray-800">
                                                            Call {index + 1}: {call.customerName}
                                                        </h3>
                                                        {(call.department || call.service || call.serviceType) && (
                                                            <p className="text-xs md:text-sm text-gray-600">
                                                                {call.department && call.service 
                                                                    ? `${call.department} - ${call.service}`
                                                                    : call.serviceType || call.department || call.service}
                                                            </p>
                                                        )}
                                                        {(call.timestamp || call.callTime) && (
                                                            <p className="text-xs text-gray-500">
                                                                {new Date(call.timestamp || call.callTime).toLocaleString()}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className={`px-3 py-1 rounded-full font-semibold ${
                                                            review.avgScore === 'N/A' 
                                                                ? 'bg-gray-400 text-white' 
                                                                : getRatingColor(Math.round(review.avgScore))
                                                        }`}>
                                                            {review.avgScore === 'N/A' ? 'N/A' : `${review.avgScore}/5.0`}
                                                        </span>
                                                        <div className="flex gap-2 no-print">
                                                            {!reviewData.completed && (
                                                                <>
                                                                    <button
                                                                        onClick={() => editCall(call)}
                                                                        className="text-blue-600 hover:text-blue-800 font-medium"
                                                                    >
                                                                        Edit
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeCall(call.id)}
                                                                        className="text-red-600 hover:text-red-800 font-medium"
                                                                    >
                                                                        Remove
                                                                    </button>
                                                                </>
                                                            )}
                                                            {reviewData.completed && (
                                                                <span className="text-gray-500 font-medium">
                                                                    Locked
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 mb-3">
                                                    {serviceSteps.map(step => (
                                                        <div key={step.key} className="text-center">
                                                            <div className={`text-xs font-medium px-2 py-1 rounded ${
                                                                call[step.key] === 'N/A' 
                                                                    ? 'bg-gray-400 text-white' 
                                                                    : getRatingColor(call[step.key])
                                                            }`}>
                                                                {step.label}: {call[step.key] === 'N/A' ? 'N/A' : call[step.key]}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="bg-gray-50 rounded p-3 mb-2">
                                                    <p className="text-sm text-gray-700">{review.summary}</p>
                                                </div>
                                                
                                                {review.checklistDetails && (
                                                    <div className="bg-white border border-gray-200 rounded p-3 mb-2">
                                                        <h4 className="text-xs font-bold text-gray-800 mb-2">✓ Completed Items:</h4>
                                                        <pre className="text-xs text-gray-700 whitespace-pre-wrap font-sans">{review.checklistDetails}</pre>
                                                    </div>
                                                )}

                                                {call.notes && (
                                                    <div className="text-sm text-gray-600 italic mb-2">
                                                        <strong>Notes:</strong> {call.notes}
                                                    </div>
                                                )}

                                                {call.nextStep && (
                                                    <div className="text-sm text-blue-700 font-medium bg-blue-50 p-2 rounded">
                                                        <strong>Next Step:</strong> {call.nextStep}
                                                    </div>
                                                )}
                                                
                                                {/* Detailed Checklist Items - Shows checked items */}
                                                {call.checklists && (
                                                    <details className="mt-3 border-t pt-3">
                                                        <summary className="cursor-pointer font-medium text-gray-700 text-sm mb-2">
                                                            📋 View Detailed Checklist ({(() => {
                                                                let total = 0;
                                                                serviceSteps.forEach(step => {
                                                                    const checklist = call.checklists[step.key];
                                                                    const naArray = call.checklistNA && call.checklistNA[step.key];
                                                                    if (checklist) {
                                                                        checklist.forEach((checked, idx) => {
                                                                            if (checked && !(naArray && naArray[idx])) {
                                                                                total++;
                                                                            }
                                                                        });
                                                                    }
                                                                });
                                                                return total;
                                                            })()} items completed)
                                                        </summary>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                                                            {serviceSteps.map(step => {
                                                                const checkedItems = call.checklists[step.key] || [];
                                                                const naArray = call.checklistNA && call.checklistNA[step.key];
                                                                
                                                                // Count excluding N/A items
                                                                let checkedCount = 0;
                                                                let applicableTotal = 0;
                                                                checkedItems.forEach((checked, idx) => {
                                                                    if (!(naArray && naArray[idx])) {
                                                                        applicableTotal++;
                                                                        if (checked) checkedCount++;
                                                                    }
                                                                });
                                                                
                                                                return (
                                                                    <div key={step.key} className="bg-gray-50 p-2 rounded border-l-3 border-blue-500">
                                                                        <div className="font-semibold text-xs text-gray-800 mb-1">
                                                                            {step.label} ({checkedCount}/{applicableTotal})
                                                                        </div>
                                                                        <ul className="text-xs space-y-0.5 checklist-print">
                                                                            {step.checklist.map((item, idx) => {
                                                                                const isNA = naArray && naArray[idx];
                                                                                const isChecked = checkedItems[idx];
                                                                                return (
                                                                                    <li key={idx} className="flex items-start">
                                                                                        <span className="mr-1">
                                                                                            {isNA ? 'N/A' : (isChecked ? '☑' : '☐')}
                                                                                        </span>
                                                                                        <span className={isNA ? 'text-gray-400 italic' : (isChecked ? 'text-gray-700' : 'text-gray-400')}>
                                                                                            {item}
                                                                                        </span>
                                                                                    </li>
                                                                                );
                                                                            })}
                                                                        </ul>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </details>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Overall Summary and Next Steps */}
                        {reviewData.calls.length > 0 && (
                            <>
                                {/* Screen Version */}
                                <div className="bg-white rounded-lg shadow-md p-6 mb-6 page-break no-print">
                                    {reviewData.completed && (
                                        <div className="bg-green-100 border-2 border-green-600 rounded-lg p-4 mb-6">
                                            <div className="flex items-center justify-between gap-3">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-3xl">✓</span>
                                                    <div>
                                                        <h3 className="text-xl font-bold text-green-800">Review Completed</h3>
                                                        <p className="text-sm text-green-700">
                                                            Finalized on {new Date(reviewData.completedAt).toLocaleString()}
                                                        </p>
                                                        <p className="text-sm text-green-700 mt-1">
                                                            This review is locked. Click Unlock to make changes.
                                                        </p>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={unlockReview}
                                                    className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md font-medium text-sm whitespace-nowrap no-print"
                                                >
                                                    🔓 Unlock Review
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                        {reviewData.completed ? 'Final Evaluation Summary' : 'Overall Day Summary'}
                                    </h2>
                                    <div className={`${reviewData.completed ? 'bg-blue-50 border-2 border-blue-300' : 'bg-green-50 border border-green-200'} rounded-lg p-4 mb-4`}>
                                        <pre className="whitespace-pre-wrap text-sm text-gray-900" style={{fontFamily: 'Courier New, monospace', lineHeight: '1.4'}}>
                                            {reviewData.completed && reviewData.finalSummary 
                                                ? reviewData.finalSummary 
                                                : generateOverallSummary()}
                                        </pre>
                                    </div>

                                    {!reviewData.completed && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Next Steps & Action Items
                                            </label>
                                            <textarea
                                                value={reviewData.nextSteps}
                                                onChange={(e) => setReviewData({...reviewData, nextSteps: e.target.value})}
                                                rows="4"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                                                placeholder="Schedule follow-up training, assign mentorship, set performance goals..."
                                            />
                                        </div>
                                    )}

                                    {reviewData.completed && reviewData.nextSteps && (
                                        <div className="mt-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Next Steps & Action Items
                                            </label>
                                            <div className="bg-gray-50 border border-gray-300 rounded-md p-3">
                                                <p className="text-gray-800 whitespace-pre-wrap">{reviewData.nextSteps}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Print Version */}
                                <div className="print-only page-break" style={{padding: '20px'}}>
                                    <h2 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '20px', textAlign: 'center'}}>
                                        {reviewData.completed ? 'FINAL EVALUATION SUMMARY' : 'OVERALL DAY SUMMARY'}
                                    </h2>
                                    
                                    {reviewData.completed && (
                                        <div style={{backgroundColor: '#e8f5e9', border: '2px solid #4caf50', padding: '15px', marginBottom: '20px', borderRadius: '5px'}}>
                                            <p style={{fontWeight: 'bold', fontSize: '16px'}}>✓ REVIEW COMPLETED</p>
                                            <p style={{fontSize: '12px'}}>Finalized on {new Date(reviewData.completedAt).toLocaleString()}</p>
                                        </div>
                                    )}
                                    
                                    <pre style={{whiteSpace: 'pre-wrap', fontFamily: 'Courier New, monospace', fontSize: '10pt', lineHeight: '1.3', border: '1px solid #ccc', padding: '15px', backgroundColor: '#f9f9f9'}}>
                                        {reviewData.completed && reviewData.finalSummary 
                                            ? reviewData.finalSummary 
                                            : generateOverallSummary()}
                                    </pre>

                                    {reviewData.nextSteps && (
                                        <div style={{marginTop: '20px', pageBreakInside: 'avoid'}}>
                                            <h3 style={{fontWeight: 'bold', fontSize: '16px', marginBottom: '10px'}}>Next Steps & Action Items</h3>
                                            <div style={{border: '1px solid #ccc', padding: '15px', backgroundColor: '#f5f5f5'}}>
                                                <p style={{whiteSpace: 'pre-wrap'}}>{reviewData.nextSteps}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* Action Buttons */}
                        {reviewData.calls.length > 0 && reviewData.technicianName && (
                            <>
                                {!reviewData.completed && (
                                    <div className="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
                                        <button
                                            onClick={completeReview}
                                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-md transition duration-200 text-lg"
                                        >
                                            ✓ Complete Review & Generate Final Summary
                                        </button>
                                        <p className="text-center text-sm text-gray-600 mt-2">
                                            Completing the review will lock all edits and generate a comprehensive final evaluation.
                                        </p>
                                    </div>
                                )}

                                <div className="bg-white rounded-lg shadow-md p-6 no-print">
                                    <div className="flex flex-col md:flex-row gap-3 md:gap-4">
                                        <button
                                            onClick={() => setShowPrintPreview(true)}
                                            className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                        >
                                            🔍 Print Preview
                                        </button>
                                        <button
                                            onClick={printToPDF}
                                            className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                        >
                                            🖨️ Print to PDF
                                        </button>
                                        <button
                                            onClick={generatePDF}
                                            className="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                        >
                                            📄 Download PDF
                                        </button>
                                        <button
                                            onClick={sendEmail}
                                            className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-md transition duration-200"
                                        >
                                            ✉️ Email Review
                                        </button>
                                    </div>
                                    {reviewData.completed && (
                                        <p className="text-center text-sm text-green-700 font-medium mt-3">
                                            ✓ Review is completed and ready for export
                                        </p>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(
            <ErrorBoundary>
                <NexStarReviewTool />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
    </script>
</body>
</html>
